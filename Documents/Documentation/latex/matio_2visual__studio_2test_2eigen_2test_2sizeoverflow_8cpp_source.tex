\hypertarget{matio_2visual__studio_2test_2eigen_2test_2sizeoverflow_8cpp_source}{}\section{matio/visual\+\_\+studio/test/eigen/test/sizeoverflow.cpp}
\label{matio_2visual__studio_2test_2eigen_2test_2sizeoverflow_8cpp_source}\index{sizeoverflow.\+cpp@{sizeoverflow.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of Eigen, a lightweight C++ template library}
00002 \textcolor{comment}{// for linear algebra.}
00003 \textcolor{comment}{//}
00004 \textcolor{comment}{// Copyright (C) 2011 Benoit Jacob <jacob.benoit.1@gmail.com>}
00005 \textcolor{comment}{//}
00006 \textcolor{comment}{// This Source Code Form is subject to the terms of the Mozilla}
00007 \textcolor{comment}{// Public License v. 2.0. If a copy of the MPL was not distributed}
00008 \textcolor{comment}{// with this file, You can obtain one at http://mozilla.org/MPL/2.0/.}
00009 
00010 \textcolor{preprocessor}{#include "main.h"}
00011 
00012 \textcolor{preprocessor}{#define VERIFY\_THROWS\_BADALLOC(a) \{                           \(\backslash\)}
00013 \textcolor{preprocessor}{    bool threw = false;                                       \(\backslash\)}
00014 \textcolor{preprocessor}{    try \{                                                     \(\backslash\)}
00015 \textcolor{preprocessor}{      a;                                                      \(\backslash\)}
00016 \textcolor{preprocessor}{    \}                                                         \(\backslash\)}
00017 \textcolor{preprocessor}{    catch (std::bad\_alloc&) \{ threw = true; \}                 \(\backslash\)}
00018 \textcolor{preprocessor}{    VERIFY(threw && "should have thrown bad\_alloc: " #a);     \(\backslash\)}
00019 \textcolor{preprocessor}{  \}}
00020 
00021 \textcolor{keyword}{template}<\textcolor{keyword}{typename} MatrixType>
00022 \textcolor{keywordtype}{void} triggerMatrixBadAlloc(\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index} rows, \hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index} cols)
00023 \{
00024   VERIFY\_THROWS\_BADALLOC( MatrixType m(rows, cols) );
00025   VERIFY\_THROWS\_BADALLOC( MatrixType m; m.resize(rows, cols) );
00026   VERIFY\_THROWS\_BADALLOC( MatrixType m; m.conservativeResize(rows, cols) );
00027 \}
00028 
00029 \textcolor{keyword}{template}<\textcolor{keyword}{typename} VectorType>
00030 \textcolor{keywordtype}{void} triggerVectorBadAlloc(\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index} size)
00031 \{
00032   VERIFY\_THROWS\_BADALLOC( \hyperlink{struct_vector_type}{VectorType} v(size) );
00033   VERIFY\_THROWS\_BADALLOC( \hyperlink{struct_vector_type}{VectorType} v; v.resize(size) );
00034   VERIFY\_THROWS\_BADALLOC( \hyperlink{struct_vector_type}{VectorType} v; v.conservativeResize(size) );
00035 \}
00036 
00037 \textcolor{keywordtype}{void} test\_sizeoverflow()
00038 \{
00039   \textcolor{comment}{// there are 2 levels of overflow checking. first in PlainObjectBase.h we check for overflow in rows*cols
       computations.}
00040   \textcolor{comment}{// this is tested in tests of the form times\_itself\_gives\_0 * times\_itself\_gives\_0}
00041   \textcolor{comment}{// Then in Memory.h we check for overflow in size * sizeof(T) computations.}
00042   \textcolor{comment}{// this is tested in tests of the form times\_4\_gives\_0 * sizeof(float)}
00043   
00044   \textcolor{keywordtype}{size\_t} times\_itself\_gives\_0 = size\_t(1) << (8 * \textcolor{keyword}{sizeof}(\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}) / 2);
00045   VERIFY(times\_itself\_gives\_0 * times\_itself\_gives\_0 == 0);
00046 
00047   \textcolor{keywordtype}{size\_t} times\_4\_gives\_0 = size\_t(1) << (8 * \textcolor{keyword}{sizeof}(\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}) - 2);
00048   VERIFY(times\_4\_gives\_0 * 4 == 0);
00049 
00050   \textcolor{keywordtype}{size\_t} times\_8\_gives\_0 = size\_t(1) << (8 * \textcolor{keyword}{sizeof}(\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}) - 3);
00051   VERIFY(times\_8\_gives\_0 * 8 == 0);
00052 
00053   triggerMatrixBadAlloc<MatrixXf>(times\_itself\_gives\_0, times\_itself\_gives\_0);
00054   triggerMatrixBadAlloc<MatrixXf>(times\_itself\_gives\_0 / 4, times\_itself\_gives\_0);
00055   triggerMatrixBadAlloc<MatrixXf>(times\_4\_gives\_0, 1);
00056 
00057   triggerMatrixBadAlloc<MatrixXd>(times\_itself\_gives\_0, times\_itself\_gives\_0);
00058   triggerMatrixBadAlloc<MatrixXd>(times\_itself\_gives\_0 / 8, times\_itself\_gives\_0);
00059   triggerMatrixBadAlloc<MatrixXd>(times\_8\_gives\_0, 1);
00060   
00061   triggerVectorBadAlloc<VectorXf>(times\_4\_gives\_0);
00062   
00063   triggerVectorBadAlloc<VectorXd>(times\_8\_gives\_0);
00064 \}
\end{DoxyCode}
