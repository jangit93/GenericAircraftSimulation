\hypertarget{zlib_2contrib_2minizip_2ioapi_8c_source}{}\section{zlib/contrib/minizip/ioapi.c}
\label{zlib_2contrib_2minizip_2ioapi_8c_source}\index{ioapi.\+c@{ioapi.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* ioapi.h -- IO base function header for compress/uncompress .zip}
00002 \textcolor{comment}{   part of the MiniZip project - ( http://www.winimage.com/zLibDll/minizip.html )}
00003 \textcolor{comment}{}
00004 \textcolor{comment}{         Copyright (C) 1998-2010 Gilles Vollant (minizip) ( http://www.winimage.com/zLibDll/minizip.html )}
00005 \textcolor{comment}{}
00006 \textcolor{comment}{         Modifications for Zip64 support}
00007 \textcolor{comment}{         Copyright (C) 2009-2010 Mathias Svensson ( http://result42.com )}
00008 \textcolor{comment}{}
00009 \textcolor{comment}{         For more info read MiniZip\_info.txt}
00010 \textcolor{comment}{}
00011 \textcolor{comment}{*/}
00012 
00013 \textcolor{preprocessor}{#if defined(\_WIN32) && (!(defined(\_CRT\_SECURE\_NO\_WARNINGS)))}
00014 \textcolor{preprocessor}{        #define \_CRT\_SECURE\_NO\_WARNINGS}
00015 \textcolor{preprocessor}{#endif}
00016 
00017 \textcolor{preprocessor}{#if defined(\_\_APPLE\_\_) || defined(IOAPI\_NO\_64)}
00018 \textcolor{comment}{// In darwin and perhaps other BSD variants off\_t is a 64 bit value, hence no need for specific 64 bit
       functions}
00019 \textcolor{preprocessor}{#define FOPEN\_FUNC(filename, mode) fopen(filename, mode)}
00020 \textcolor{preprocessor}{#define FTELLO\_FUNC(stream) ftello(stream)}
00021 \textcolor{preprocessor}{#define FSEEKO\_FUNC(stream, offset, origin) fseeko(stream, offset, origin)}
00022 \textcolor{preprocessor}{#else}
00023 \textcolor{preprocessor}{#define FOPEN\_FUNC(filename, mode) fopen64(filename, mode)}
00024 \textcolor{preprocessor}{#define FTELLO\_FUNC(stream) ftello64(stream)}
00025 \textcolor{preprocessor}{#define FSEEKO\_FUNC(stream, offset, origin) fseeko64(stream, offset, origin)}
00026 \textcolor{preprocessor}{#endif}
00027 
00028 
00029 \textcolor{preprocessor}{#include "ioapi.h"}
00030 
00031 voidpf call\_zopen64 (\textcolor{keyword}{const} \hyperlink{structzlib__filefunc64__32__def__s}{zlib\_filefunc64\_32\_def}* pfilefunc,\textcolor{keyword}{const} \textcolor{keywordtype}{void}*filename,\textcolor{keywordtype}{int} 
      mode)
00032 \{
00033     \textcolor{keywordflow}{if} (pfilefunc->zfile\_func64.zopen64\_file != NULL)
00034         \textcolor{keywordflow}{return} (*(pfilefunc->zfile\_func64.zopen64\_file)) (pfilefunc->zfile\_func64.opaque,filename,mode);
00035     \textcolor{keywordflow}{else}
00036     \{
00037         \textcolor{keywordflow}{return} (*(pfilefunc->zopen32\_file))(pfilefunc->zfile\_func64.opaque,(\textcolor{keyword}{const} \textcolor{keywordtype}{char}*)filename,mode);
00038     \}
00039 \}
00040 
00041 \textcolor{keywordtype}{long} call\_zseek64 (\textcolor{keyword}{const} \hyperlink{structzlib__filefunc64__32__def__s}{zlib\_filefunc64\_32\_def}* pfilefunc,voidpf filestream, 
      ZPOS64\_T offset, \textcolor{keywordtype}{int} origin)
00042 \{
00043     \textcolor{keywordflow}{if} (pfilefunc->zfile\_func64.zseek64\_file != NULL)
00044         \textcolor{keywordflow}{return} (*(pfilefunc->zfile\_func64.zseek64\_file)) (pfilefunc->zfile\_func64.opaque,filestream,offset,
      origin);
00045     \textcolor{keywordflow}{else}
00046     \{
00047         uLong offsetTruncated = (uLong)offset;
00048         \textcolor{keywordflow}{if} (offsetTruncated != offset)
00049             \textcolor{keywordflow}{return} -1;
00050         \textcolor{keywordflow}{else}
00051             \textcolor{keywordflow}{return} (*(pfilefunc->zseek32\_file))(pfilefunc->zfile\_func64.opaque,filestream,offsetTruncated,
      origin);
00052     \}
00053 \}
00054 
00055 ZPOS64\_T call\_ztell64 (\textcolor{keyword}{const} \hyperlink{structzlib__filefunc64__32__def__s}{zlib\_filefunc64\_32\_def}* pfilefunc,voidpf filestream)
00056 \{
00057     \textcolor{keywordflow}{if} (pfilefunc->zfile\_func64.zseek64\_file != NULL)
00058         \textcolor{keywordflow}{return} (*(pfilefunc->zfile\_func64.ztell64\_file)) (pfilefunc->zfile\_func64.opaque,filestream);
00059     \textcolor{keywordflow}{else}
00060     \{
00061         uLong tell\_uLong = (*(pfilefunc->ztell32\_file))(pfilefunc->zfile\_func64.opaque,filestream);
00062         \textcolor{keywordflow}{if} ((tell\_uLong) == MAXU32)
00063             \textcolor{keywordflow}{return} (ZPOS64\_T)-1;
00064         \textcolor{keywordflow}{else}
00065             \textcolor{keywordflow}{return} tell\_uLong;
00066     \}
00067 \}
00068 
00069 \textcolor{keywordtype}{void} fill\_zlib\_filefunc64\_32\_def\_from\_filefunc32(\hyperlink{structzlib__filefunc64__32__def__s}{zlib\_filefunc64\_32\_def}* 
      p\_filefunc64\_32,\textcolor{keyword}{const} \hyperlink{structzlib__filefunc__def__s}{zlib\_filefunc\_def}* p\_filefunc32)
00070 \{
00071     p\_filefunc64\_32->zfile\_func64.zopen64\_file = NULL;
00072     p\_filefunc64\_32->zopen32\_file = p\_filefunc32->zopen\_file;
00073     p\_filefunc64\_32->zfile\_func64.zerror\_file = p\_filefunc32->zerror\_file;
00074     p\_filefunc64\_32->zfile\_func64.zread\_file = p\_filefunc32->zread\_file;
00075     p\_filefunc64\_32->zfile\_func64.zwrite\_file = p\_filefunc32->zwrite\_file;
00076     p\_filefunc64\_32->zfile\_func64.ztell64\_file = NULL;
00077     p\_filefunc64\_32->zfile\_func64.zseek64\_file = NULL;
00078     p\_filefunc64\_32->zfile\_func64.zclose\_file = p\_filefunc32->zclose\_file;
00079     p\_filefunc64\_32->zfile\_func64.zerror\_file = p\_filefunc32->zerror\_file;
00080     p\_filefunc64\_32->zfile\_func64.opaque = p\_filefunc32->opaque;
00081     p\_filefunc64\_32->zseek32\_file = p\_filefunc32->zseek\_file;
00082     p\_filefunc64\_32->ztell32\_file = p\_filefunc32->ztell\_file;
00083 \}
00084 
00085 
00086 
00087 \textcolor{keyword}{static} voidpf  ZCALLBACK fopen\_file\_func OF((voidpf opaque, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* filename, \textcolor{keywordtype}{int} mode));
00088 \textcolor{keyword}{static} uLong   ZCALLBACK fread\_file\_func OF((voidpf opaque, voidpf stream, \textcolor{keywordtype}{void}* buf, uLong size));
00089 \textcolor{keyword}{static} uLong   ZCALLBACK fwrite\_file\_func OF((voidpf opaque, voidpf stream, \textcolor{keyword}{const} \textcolor{keywordtype}{void}* buf,uLong size));
00090 \textcolor{keyword}{static} ZPOS64\_T ZCALLBACK ftell64\_file\_func OF((voidpf opaque, voidpf stream));
00091 \textcolor{keyword}{static} \textcolor{keywordtype}{long}    ZCALLBACK fseek64\_file\_func OF((voidpf opaque, voidpf stream, ZPOS64\_T offset, \textcolor{keywordtype}{int} origin));
00092 \textcolor{keyword}{static} \textcolor{keywordtype}{int}     ZCALLBACK fclose\_file\_func OF((voidpf opaque, voidpf stream));
00093 \textcolor{keyword}{static} \textcolor{keywordtype}{int}     ZCALLBACK ferror\_file\_func OF((voidpf opaque, voidpf stream));
00094 
00095 \textcolor{keyword}{static} voidpf ZCALLBACK fopen\_file\_func (voidpf opaque, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* filename, \textcolor{keywordtype}{int} mode)
00096 \{
00097     FILE* \hyperlink{structfile}{file} = NULL;
00098     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* mode\_fopen = NULL;
00099     \textcolor{keywordflow}{if} ((mode & ZLIB\_FILEFUNC\_MODE\_READWRITEFILTER)==ZLIB\_FILEFUNC\_MODE\_READ)
00100         mode\_fopen = \textcolor{stringliteral}{"rb"};
00101     \textcolor{keywordflow}{else}
00102     \textcolor{keywordflow}{if} (mode & ZLIB\_FILEFUNC\_MODE\_EXISTING)
00103         mode\_fopen = \textcolor{stringliteral}{"r+b"};
00104     \textcolor{keywordflow}{else}
00105     \textcolor{keywordflow}{if} (mode & ZLIB\_FILEFUNC\_MODE\_CREATE)
00106         mode\_fopen = \textcolor{stringliteral}{"wb"};
00107 
00108     \textcolor{keywordflow}{if} ((filename!=NULL) && (mode\_fopen != NULL))
00109         file = fopen(filename, mode\_fopen);
00110     \textcolor{keywordflow}{return} file;
00111 \}
00112 
00113 \textcolor{keyword}{static} voidpf ZCALLBACK fopen64\_file\_func (voidpf opaque, \textcolor{keyword}{const} \textcolor{keywordtype}{void}* filename, \textcolor{keywordtype}{int} mode)
00114 \{
00115     FILE* file = NULL;
00116     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* mode\_fopen = NULL;
00117     \textcolor{keywordflow}{if} ((mode & ZLIB\_FILEFUNC\_MODE\_READWRITEFILTER)==ZLIB\_FILEFUNC\_MODE\_READ)
00118         mode\_fopen = \textcolor{stringliteral}{"rb"};
00119     \textcolor{keywordflow}{else}
00120     \textcolor{keywordflow}{if} (mode & ZLIB\_FILEFUNC\_MODE\_EXISTING)
00121         mode\_fopen = \textcolor{stringliteral}{"r+b"};
00122     \textcolor{keywordflow}{else}
00123     \textcolor{keywordflow}{if} (mode & ZLIB\_FILEFUNC\_MODE\_CREATE)
00124         mode\_fopen = \textcolor{stringliteral}{"wb"};
00125 
00126     \textcolor{keywordflow}{if} ((filename!=NULL) && (mode\_fopen != NULL))
00127         file = FOPEN\_FUNC((\textcolor{keyword}{const} \textcolor{keywordtype}{char}*)filename, mode\_fopen);
00128     \textcolor{keywordflow}{return} file;
00129 \}
00130 
00131 
00132 \textcolor{keyword}{static} uLong ZCALLBACK fread\_file\_func (voidpf opaque, voidpf stream, \textcolor{keywordtype}{void}* buf, uLong size)
00133 \{
00134     uLong ret;
00135     ret = (uLong)fread(buf, 1, (\textcolor{keywordtype}{size\_t})size, (FILE *)stream);
00136     \textcolor{keywordflow}{return} ret;
00137 \}
00138 
00139 \textcolor{keyword}{static} uLong ZCALLBACK fwrite\_file\_func (voidpf opaque, voidpf stream, \textcolor{keyword}{const} \textcolor{keywordtype}{void}* buf, uLong size)
00140 \{
00141     uLong ret;
00142     ret = (uLong)fwrite(buf, 1, (\textcolor{keywordtype}{size\_t})size, (FILE *)stream);
00143     \textcolor{keywordflow}{return} ret;
00144 \}
00145 
00146 \textcolor{keyword}{static} \textcolor{keywordtype}{long} ZCALLBACK ftell\_file\_func (voidpf opaque, voidpf stream)
00147 \{
00148     \textcolor{keywordtype}{long} ret;
00149     ret = ftell((FILE *)stream);
00150     \textcolor{keywordflow}{return} ret;
00151 \}
00152 
00153 
00154 \textcolor{keyword}{static} ZPOS64\_T ZCALLBACK ftell64\_file\_func (voidpf opaque, voidpf stream)
00155 \{
00156     ZPOS64\_T ret;
00157     ret = FTELLO\_FUNC((FILE *)stream);
00158     \textcolor{keywordflow}{return} ret;
00159 \}
00160 
00161 \textcolor{keyword}{static} \textcolor{keywordtype}{long} ZCALLBACK fseek\_file\_func (voidpf  opaque, voidpf stream, uLong offset, \textcolor{keywordtype}{int} origin)
00162 \{
00163     \textcolor{keywordtype}{int} fseek\_origin=0;
00164     \textcolor{keywordtype}{long} ret;
00165     \textcolor{keywordflow}{switch} (origin)
00166     \{
00167     \textcolor{keywordflow}{case} ZLIB\_FILEFUNC\_SEEK\_CUR :
00168         fseek\_origin = SEEK\_CUR;
00169         \textcolor{keywordflow}{break};
00170     \textcolor{keywordflow}{case} ZLIB\_FILEFUNC\_SEEK\_END :
00171         fseek\_origin = SEEK\_END;
00172         \textcolor{keywordflow}{break};
00173     \textcolor{keywordflow}{case} ZLIB\_FILEFUNC\_SEEK\_SET :
00174         fseek\_origin = SEEK\_SET;
00175         \textcolor{keywordflow}{break};
00176     \textcolor{keywordflow}{default}: \textcolor{keywordflow}{return} -1;
00177     \}
00178     ret = 0;
00179     \textcolor{keywordflow}{if} (fseek((FILE *)stream, offset, fseek\_origin) != 0)
00180         ret = -1;
00181     \textcolor{keywordflow}{return} ret;
00182 \}
00183 
00184 \textcolor{keyword}{static} \textcolor{keywordtype}{long} ZCALLBACK fseek64\_file\_func (voidpf  opaque, voidpf stream, ZPOS64\_T offset, \textcolor{keywordtype}{int} origin)
00185 \{
00186     \textcolor{keywordtype}{int} fseek\_origin=0;
00187     \textcolor{keywordtype}{long} ret;
00188     \textcolor{keywordflow}{switch} (origin)
00189     \{
00190     \textcolor{keywordflow}{case} ZLIB\_FILEFUNC\_SEEK\_CUR :
00191         fseek\_origin = SEEK\_CUR;
00192         \textcolor{keywordflow}{break};
00193     \textcolor{keywordflow}{case} ZLIB\_FILEFUNC\_SEEK\_END :
00194         fseek\_origin = SEEK\_END;
00195         \textcolor{keywordflow}{break};
00196     \textcolor{keywordflow}{case} ZLIB\_FILEFUNC\_SEEK\_SET :
00197         fseek\_origin = SEEK\_SET;
00198         \textcolor{keywordflow}{break};
00199     \textcolor{keywordflow}{default}: \textcolor{keywordflow}{return} -1;
00200     \}
00201     ret = 0;
00202 
00203     \textcolor{keywordflow}{if}(FSEEKO\_FUNC((FILE *)stream, offset, fseek\_origin) != 0)
00204                         ret = -1;
00205 
00206     \textcolor{keywordflow}{return} ret;
00207 \}
00208 
00209 
00210 \textcolor{keyword}{static} \textcolor{keywordtype}{int} ZCALLBACK fclose\_file\_func (voidpf opaque, voidpf stream)
00211 \{
00212     \textcolor{keywordtype}{int} ret;
00213     ret = fclose((FILE *)stream);
00214     \textcolor{keywordflow}{return} ret;
00215 \}
00216 
00217 \textcolor{keyword}{static} \textcolor{keywordtype}{int} ZCALLBACK ferror\_file\_func (voidpf opaque, voidpf stream)
00218 \{
00219     \textcolor{keywordtype}{int} ret;
00220     ret = ferror((FILE *)stream);
00221     \textcolor{keywordflow}{return} ret;
00222 \}
00223 
00224 \textcolor{keywordtype}{void} fill\_fopen\_filefunc (pzlib\_filefunc\_def)
00225   \hyperlink{structzlib__filefunc__def__s}{zlib\_filefunc\_def}* pzlib\_filefunc\_def;
00226 \{
00227     pzlib\_filefunc\_def->zopen\_file = fopen\_file\_func;
00228     pzlib\_filefunc\_def->zread\_file = fread\_file\_func;
00229     pzlib\_filefunc\_def->zwrite\_file = fwrite\_file\_func;
00230     pzlib\_filefunc\_def->ztell\_file = ftell\_file\_func;
00231     pzlib\_filefunc\_def->zseek\_file = fseek\_file\_func;
00232     pzlib\_filefunc\_def->zclose\_file = fclose\_file\_func;
00233     pzlib\_filefunc\_def->zerror\_file = ferror\_file\_func;
00234     pzlib\_filefunc\_def->opaque = NULL;
00235 \}
00236 
00237 \textcolor{keywordtype}{void} fill\_fopen64\_filefunc (\hyperlink{structzlib__filefunc64__def__s}{zlib\_filefunc64\_def}*  pzlib\_filefunc\_def)
00238 \{
00239     pzlib\_filefunc\_def->zopen64\_file = fopen64\_file\_func;
00240     pzlib\_filefunc\_def->zread\_file = fread\_file\_func;
00241     pzlib\_filefunc\_def->zwrite\_file = fwrite\_file\_func;
00242     pzlib\_filefunc\_def->ztell64\_file = ftell64\_file\_func;
00243     pzlib\_filefunc\_def->zseek64\_file = fseek64\_file\_func;
00244     pzlib\_filefunc\_def->zclose\_file = fclose\_file\_func;
00245     pzlib\_filefunc\_def->zerror\_file = ferror\_file\_func;
00246     pzlib\_filefunc\_def->opaque = NULL;
00247 \}
\end{DoxyCode}
