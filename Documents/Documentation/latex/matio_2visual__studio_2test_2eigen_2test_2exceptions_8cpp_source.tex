\hypertarget{matio_2visual__studio_2test_2eigen_2test_2exceptions_8cpp_source}{}\section{matio/visual\+\_\+studio/test/eigen/test/exceptions.cpp}
\label{matio_2visual__studio_2test_2eigen_2test_2exceptions_8cpp_source}\index{exceptions.\+cpp@{exceptions.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of Eigen, a lightweight C++ template library}
00002 \textcolor{comment}{// for linear algebra.}
00003 \textcolor{comment}{//}
00004 \textcolor{comment}{// Copyright (C) 2011 Gael Guennebaud <gael.guennebaud@inria.fr>}
00005 \textcolor{comment}{//}
00006 \textcolor{comment}{// This Source Code Form is subject to the terms of the Mozilla}
00007 \textcolor{comment}{// Public License v. 2.0. If a copy of the MPL was not distributed}
00008 \textcolor{comment}{// with this file, You can obtain one at http://mozilla.org/MPL/2.0/.}
00009 
00010 
00011 \textcolor{comment}{// Various sanity tests with exceptions:}
00012 \textcolor{comment}{//  - no memory leak when a custom scalar type trow an exceptions}
00013 \textcolor{comment}{//  - todo: complete the list of tests!}
00014 
00015 \textcolor{preprocessor}{#define EIGEN\_STACK\_ALLOCATION\_LIMIT 100000000}
00016 
00017 \textcolor{preprocessor}{#include "main.h"}
00018 
00019 \textcolor{keyword}{struct }\hyperlink{structmy__exception}{my\_exception}
00020 \{
00021   \hyperlink{structmy__exception}{my\_exception}() \{\}
00022   ~\hyperlink{structmy__exception}{my\_exception}() \{\}
00023 \};
00024     
00025 \textcolor{keyword}{class }\hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}
00026 \{
00027   \textcolor{keyword}{public}:
00028     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}() \{ \hyperlink{structinit}{init}(); \}
00029     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}(\textcolor{keyword}{const} \textcolor{keywordtype}{float}& \_v) \{ \hyperlink{structinit}{init}(); *v = \_v; \}
00030     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}(\textcolor{keyword}{const} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other) \{ 
      \hyperlink{structinit}{init}(); *v = *(other.v); \}
00031     ~\hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}() \{
00032       \textcolor{keyword}{delete} v;
00033       instances--;
00034     \}
00035 
00036     \textcolor{keywordtype}{void} \hyperlink{structinit}{init}() \{
00037       v = \textcolor{keyword}{new} float;
00038       instances++;
00039     \}
00040 
00041     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} operator+(\textcolor{keyword}{const} 
      \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other)\textcolor{keyword}{ const}
00042 \textcolor{keyword}{    }\{
00043       countdown--;
00044       \textcolor{keywordflow}{if}(countdown<=0)
00045         \textcolor{keywordflow}{throw} \hyperlink{structmy__exception}{my\_exception}();
00046       \textcolor{keywordflow}{return} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}(*v+*other.v);
00047     \}
00048     
00049     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} operator-(\textcolor{keyword}{const} 
      \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other)\textcolor{keyword}{ const}
00050 \textcolor{keyword}{    }\{ \textcolor{keywordflow}{return} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}(*v-*other.v); \}
00051     
00052     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} operator*(\textcolor{keyword}{const} 
      \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other)\textcolor{keyword}{ const}
00053 \textcolor{keyword}{    }\{ \textcolor{keywordflow}{return} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}((*v)*(*other.v)); \}
00054     
00055     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& operator+=(\textcolor{keyword}{const} 
      \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other)
00056     \{ *v+=*other.v; \textcolor{keywordflow}{return} *\textcolor{keyword}{this}; \}
00057     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& operator-=(\textcolor{keyword}{const} 
      \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other)
00058     \{ *v-=*other.v; \textcolor{keywordflow}{return} *\textcolor{keyword}{this}; \}
00059     \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& operator=(\textcolor{keyword}{const} 
      \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other)
00060     \{ *v = *(other.v); \textcolor{keywordflow}{return} *\textcolor{keyword}{this}; \}
00061   
00062     \textcolor{keywordtype}{bool} operator==(\textcolor{keyword}{const} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other)\textcolor{keyword}{ const}
00063 \textcolor{keyword}{    }\{ \textcolor{keywordflow}{return} *v==*other.v; \}
00064     \textcolor{keywordtype}{bool} operator!=(\textcolor{keyword}{const} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions}& other)\textcolor{keyword}{ const}
00065 \textcolor{keyword}{    }\{ \textcolor{keywordflow}{return} *v!=*other.v; \}
00066     
00067     \textcolor{keywordtype}{float}* v;
00068     \textcolor{keyword}{static} \textcolor{keywordtype}{int} instances;
00069     \textcolor{keyword}{static} \textcolor{keywordtype}{int} countdown;
00070 \};
00071 
00072 \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} real(\textcolor{keyword}{const} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} &x) \{ \textcolor{keywordflow}{return} x
      ; \}
00073 \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} imag(\textcolor{keyword}{const} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} & ) \{ \textcolor{keywordflow}{return} 0
      ; \}
00074 \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} conj(\textcolor{keyword}{const} \hyperlink{class_scalar_with_exceptions}{ScalarWithExceptions} &x) \{ \textcolor{keywordflow}{return} x
      ; \}
00075 
00076 \textcolor{keywordtype}{int} ScalarWithExceptions::instances = 0;
00077 \textcolor{keywordtype}{int} ScalarWithExceptions::countdown = 0;
00078 
00079 
00080 \textcolor{preprocessor}{#define CHECK\_MEMLEAK(OP) \{                                 \(\backslash\)}
00081 \textcolor{preprocessor}{    ScalarWithExceptions::countdown = 100;                  \(\backslash\)}
00082 \textcolor{preprocessor}{    int before = ScalarWithExceptions::instances;           \(\backslash\)}
00083 \textcolor{preprocessor}{    bool exception\_thrown = false;                         \(\backslash\)}
00084 \textcolor{preprocessor}{    try \{ OP; \}                              \(\backslash\)}
00085 \textcolor{preprocessor}{    catch (my\_exception) \{                                  \(\backslash\)}
00086 \textcolor{preprocessor}{      exception\_thrown = true;                              \(\backslash\)}
00087 \textcolor{preprocessor}{      VERIFY(ScalarWithExceptions::instances==before && "memory leak detected in " &&
       EIGEN\_MAKESTRING(OP)); \(\backslash\)}
00088 \textcolor{preprocessor}{    \} \(\backslash\)}
00089 \textcolor{preprocessor}{    VERIFY(exception\_thrown && " no exception thrown in " && EIGEN\_MAKESTRING(OP)); \(\backslash\)}
00090 \textcolor{preprocessor}{  \}}
00091 
00092 \textcolor{keywordtype}{void} memoryleak()
00093 \{
00094   \textcolor{keyword}{typedef} \hyperlink{group___core___module_class_eigen_1_1_matrix}{Eigen::Matrix<ScalarWithExceptions,Dynamic,1>} 
      \hyperlink{struct_vector_type}{VectorType};
00095   \textcolor{keyword}{typedef} \hyperlink{group___core___module_class_eigen_1_1_matrix}{Eigen::Matrix<ScalarWithExceptions,Dynamic,Dynamic>}
       MatrixType;
00096   
00097   \{
00098     \textcolor{keywordtype}{int} n = 50;
00099     VectorType v0(n), v1(n);
00100     MatrixType m0(n,n), m1(n,n), m2(n,n);
00101     v0.setOnes(); v1.setOnes();
00102     m0.setOnes(); m1.setOnes(); m2.setOnes();
00103     CHECK\_MEMLEAK(v0 = m0 * m1 * v1);
00104     CHECK\_MEMLEAK(m2 = m0 * m1 * m2);
00105     CHECK\_MEMLEAK((v0+v1).dot(v0+v1));
00106   \}
00107   VERIFY(ScalarWithExceptions::instances==0 && \textcolor{stringliteral}{"global memory leak detected in "} && EIGEN\_MAKESTRING(OP)); 
      \(\backslash\)
00108 \}
00109 
00110 \textcolor{keywordtype}{void} test\_exceptions()
00111 \{
00112   CALL\_SUBTEST( memoryleak() );
00113 \}
\end{DoxyCode}
