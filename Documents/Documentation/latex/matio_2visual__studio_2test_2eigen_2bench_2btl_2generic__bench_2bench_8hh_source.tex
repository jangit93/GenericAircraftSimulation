\hypertarget{matio_2visual__studio_2test_2eigen_2bench_2btl_2generic__bench_2bench_8hh_source}{}\section{matio/visual\+\_\+studio/test/eigen/bench/btl/generic\+\_\+bench/bench.hh}
\label{matio_2visual__studio_2test_2eigen_2bench_2btl_2generic__bench_2bench_8hh_source}\index{bench.\+hh@{bench.\+hh}}

\begin{DoxyCode}
00001 \textcolor{comment}{//=====================================================}
00002 \textcolor{comment}{// File   :  bench.hh}
00003 \textcolor{comment}{// Author :  L. Plagne <laurent.plagne@edf.fr)>}
00004 \textcolor{comment}{// Copyright (C) EDF R&D,  lun sep 30 14:23:16 CEST 2002}
00005 \textcolor{comment}{//=====================================================}
00006 \textcolor{comment}{//}
00007 \textcolor{comment}{// This program is free software; you can redistribute it and/or}
00008 \textcolor{comment}{// modify it under the terms of the GNU General Public License}
00009 \textcolor{comment}{// as published by the Free Software Foundation; either version 2}
00010 \textcolor{comment}{// of the License, or (at your option) any later version.}
00011 \textcolor{comment}{//}
00012 \textcolor{comment}{// This program is distributed in the hope that it will be useful,}
00013 \textcolor{comment}{// but WITHOUT ANY WARRANTY; without even the implied warranty of}
00014 \textcolor{comment}{// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00015 \textcolor{comment}{// GNU General Public License for more details.}
00016 \textcolor{comment}{// You should have received a copy of the GNU General Public License}
00017 \textcolor{comment}{// along with this program; if not, write to the Free Software}
00018 \textcolor{comment}{// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.}
00019 \textcolor{comment}{//}
00020 \textcolor{preprocessor}{#ifndef BENCH\_HH}
00021 \textcolor{preprocessor}{#define BENCH\_HH}
00022 
00023 \textcolor{preprocessor}{#include "btl.hh"}
00024 \textcolor{preprocessor}{#include "bench\_parameter.hh"}
00025 \textcolor{preprocessor}{#include <iostream>}
00026 \textcolor{preprocessor}{#include "utilities.h"}
00027 \textcolor{preprocessor}{#include "size\_lin\_log.hh"}
00028 \textcolor{preprocessor}{#include "xy\_file.hh"}
00029 \textcolor{preprocessor}{#include <vector>}
00030 \textcolor{preprocessor}{#include <string>}
00031 \textcolor{preprocessor}{#include "timers/portable\_perf\_analyzer.hh"}
00032 \textcolor{comment}{// #include "timers/mixed\_perf\_analyzer.hh"}
00033 \textcolor{comment}{// #include "timers/x86\_perf\_analyzer.hh"}
00034 \textcolor{comment}{// #include "timers/STL\_perf\_analyzer.hh"}
00035 \textcolor{preprocessor}{#ifdef HAVE\_MKL}
00036 \textcolor{keyword}{extern} \textcolor{stringliteral}{"C"} \textcolor{keywordtype}{void} cblas\_saxpy(\textcolor{keyword}{const} \textcolor{keywordtype}{int}, \textcolor{keyword}{const} \textcolor{keywordtype}{float}, \textcolor{keyword}{const} \textcolor{keywordtype}{float}*, \textcolor{keyword}{const} \textcolor{keywordtype}{int}, \textcolor{keywordtype}{float} *, \textcolor{keyword}{const} \textcolor{keywordtype}{int});
00037 \textcolor{preprocessor}{#endif}
00038 \textcolor{keyword}{using namespace }\hyperlink{namespacestd}{std};
00039 
00040 \textcolor{keyword}{template} <\textcolor{keyword}{template}<\textcolor{keyword}{class}> \textcolor{keyword}{class }Perf\_Analyzer, \textcolor{keyword}{class }Action>
00041 BTL\_DONT\_INLINE \textcolor{keywordtype}{void} bench( \textcolor{keywordtype}{int} size\_min, \textcolor{keywordtype}{int} size\_max, \textcolor{keywordtype}{int} nb\_point )
00042 \{
00043   \textcolor{keywordflow}{if} (BtlConfig::skipAction(Action::name()))
00044     \textcolor{keywordflow}{return};
00045 
00046   \textcolor{keywordtype}{string} filename=\textcolor{stringliteral}{"bench\_"}+Action::name()+\textcolor{stringliteral}{".dat"};
00047 
00048   INFOS(\textcolor{stringliteral}{"starting "} <<filename);
00049 
00050   \textcolor{comment}{// utilities}
00051 
00052   std::vector<double> tab\_mflops(nb\_point);
00053   std::vector<int> tab\_sizes(nb\_point);
00054 
00055   \textcolor{comment}{// matrices and vector size calculations}
00056   size\_lin\_log(nb\_point,size\_min,size\_max,tab\_sizes);
00057 
00058   std::vector<int> oldSizes;
00059   std::vector<double> oldFlops;
00060   \textcolor{keywordtype}{bool} hasOldResults = read\_xy\_file(filename, oldSizes, oldFlops, \textcolor{keyword}{true});
00061   \textcolor{keywordtype}{int} oldi = oldSizes.size() - 1;
00062 
00063   \textcolor{comment}{// loop on matrix size}
00064   Perf\_Analyzer<Action> perf\_action;
00065   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=nb\_point-1;i>=0;i--)
00066   \{
00067     \textcolor{comment}{//INFOS("size=" <<tab\_sizes[i]<<"   ("<<nb\_point-i<<"/"<<nb\_point<<")");}
00068     std::cout << \textcolor{stringliteral}{" "} << \textcolor{stringliteral}{"size = "} << tab\_sizes[i] << \textcolor{stringliteral}{"  "} << std::flush;
00069 
00070     BTL\_DISABLE\_SSE\_EXCEPTIONS();
00071 \textcolor{preprocessor}{    #ifdef HAVE\_MKL}
00072     \{
00073       \textcolor{keywordtype}{float} dummy;
00074       cblas\_saxpy(1,0,&dummy,1,&dummy,1);
00075     \}
00076 \textcolor{preprocessor}{    #endif}
00077 
00078     tab\_mflops[i] = perf\_action.eval\_mflops(tab\_sizes[i]);
00079     std::cout << tab\_mflops[i];
00080     
00081     \textcolor{keywordflow}{if} (hasOldResults)
00082     \{
00083       \textcolor{keywordflow}{while} (oldi>=0 && oldSizes[oldi]>tab\_sizes[i])
00084         --oldi;
00085       \textcolor{keywordflow}{if} (oldi>=0 && oldSizes[oldi]==tab\_sizes[i])
00086       \{
00087         \textcolor{keywordflow}{if} (oldFlops[oldi]<tab\_mflops[i])
00088           std::cout << \textcolor{stringliteral}{"\(\backslash\)t > "};
00089         \textcolor{keywordflow}{else}
00090           std::cout << \textcolor{stringliteral}{"\(\backslash\)t < "};
00091         std::cout << oldFlops[oldi];
00092       \}
00093       --oldi;
00094     \}
00095     std::cout << \textcolor{stringliteral}{" MFlops    ("} << nb\_point-i << \textcolor{stringliteral}{"/"} << nb\_point << \textcolor{stringliteral}{")"} << std::endl;
00096   \}
00097 
00098   \textcolor{keywordflow}{if} (!BtlConfig::Instance.overwriteResults)
00099   \{
00100     \textcolor{keywordflow}{if} (hasOldResults)
00101     \{
00102       \textcolor{comment}{// merge the two data}
00103       std::vector<int> newSizes;
00104       std::vector<double> newFlops;
00105       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i=0;
00106       \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} j=0;
00107       \textcolor{keywordflow}{while} (i<tab\_sizes.size() && j<oldSizes.size())
00108       \{
00109         \textcolor{keywordflow}{if} (tab\_sizes[i] == oldSizes[j])
00110         \{
00111           newSizes.push\_back(tab\_sizes[i]);
00112           newFlops.push\_back(std::max(tab\_mflops[i], oldFlops[j]));
00113           ++i;
00114           ++j;
00115         \}
00116         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (tab\_sizes[i] < oldSizes[j])
00117         \{
00118           newSizes.push\_back(tab\_sizes[i]);
00119           newFlops.push\_back(tab\_mflops[i]);
00120           ++i;
00121         \}
00122         \textcolor{keywordflow}{else}
00123         \{
00124           newSizes.push\_back(oldSizes[j]);
00125           newFlops.push\_back(oldFlops[j]);
00126           ++j;
00127         \}
00128       \}
00129       \textcolor{keywordflow}{while} (i<tab\_sizes.size())
00130       \{
00131         newSizes.push\_back(tab\_sizes[i]);
00132         newFlops.push\_back(tab\_mflops[i]);
00133         ++i;
00134       \}
00135       \textcolor{keywordflow}{while} (j<oldSizes.size())
00136       \{
00137         newSizes.push\_back(oldSizes[j]);
00138         newFlops.push\_back(oldFlops[j]);
00139         ++j;
00140       \}
00141       tab\_mflops = newFlops;
00142       tab\_sizes = newSizes;
00143     \}
00144   \}
00145 
00146   \textcolor{comment}{// dump the result in a file  :}
00147   dump\_xy\_file(tab\_sizes,tab\_mflops,filename);
00148 
00149 \}
00150 
00151 \textcolor{comment}{// default Perf Analyzer}
00152 
00153 \textcolor{keyword}{template} <\textcolor{keyword}{class} Action>
00154 BTL\_DONT\_INLINE \textcolor{keywordtype}{void} bench( \textcolor{keywordtype}{int} size\_min, \textcolor{keywordtype}{int} size\_max, \textcolor{keywordtype}{int} nb\_point )\{
00155 
00156   \textcolor{comment}{// if the rdtsc is not available :}
00157   bench<Portable\_Perf\_Analyzer,Action>(size\_min,size\_max,nb\_point);
00158   \textcolor{comment}{// if the rdtsc is available :}
00159 \textcolor{comment}{//    bench<Mixed\_Perf\_Analyzer,Action>(size\_min,size\_max,nb\_point);}
00160 
00161 
00162   \textcolor{comment}{// Only for small problem size. Otherwize it will be too long}
00163 \textcolor{comment}{//   bench<X86\_Perf\_Analyzer,Action>(size\_min,size\_max,nb\_point);}
00164 \textcolor{comment}{//   bench<STL\_Perf\_Analyzer,Action>(size\_min,size\_max,nb\_point);}
00165 
00166 \}
00167 
00168 \textcolor{preprocessor}{#endif}
\end{DoxyCode}
