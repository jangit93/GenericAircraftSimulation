\hypertarget{eigen_2bench_2bench_cholesky_8cpp_source}{}\section{eigen/bench/bench\+Cholesky.cpp}
\label{eigen_2bench_2bench_cholesky_8cpp_source}\index{bench\+Cholesky.\+cpp@{bench\+Cholesky.\+cpp}}

\begin{DoxyCode}
00001 
00002 \textcolor{comment}{// g++ -DNDEBUG -O3 -I.. benchLLT.cpp  -o benchLLT && ./benchLLT}
00003 \textcolor{comment}{// options:}
00004 \textcolor{comment}{//  -DBENCH\_GSL -lgsl /usr/lib/libcblas.so.3}
00005 \textcolor{comment}{//  -DEIGEN\_DONT\_VECTORIZE}
00006 \textcolor{comment}{//  -msse2}
00007 \textcolor{comment}{//  -DREPEAT=100}
00008 \textcolor{comment}{//  -DTRIES=10}
00009 \textcolor{comment}{//  -DSCALAR=double}
00010 
00011 \textcolor{preprocessor}{#include <iostream>}
00012 
00013 \textcolor{preprocessor}{#include <Eigen/Core>}
00014 \textcolor{preprocessor}{#include <Eigen/Cholesky>}
00015 \textcolor{preprocessor}{#include <bench/BenchUtil.h>}
00016 \textcolor{keyword}{using namespace }\hyperlink{namespace_eigen}{Eigen};
00017 
00018 \textcolor{preprocessor}{#ifndef REPEAT}
00019 \textcolor{preprocessor}{#define REPEAT 10000}
00020 \textcolor{preprocessor}{#endif}
00021 
00022 \textcolor{preprocessor}{#ifndef TRIES}
00023 \textcolor{preprocessor}{#define TRIES 10}
00024 \textcolor{preprocessor}{#endif}
00025 
00026 \textcolor{keyword}{typedef} \textcolor{keywordtype}{float} Scalar;
00027 
00028 \textcolor{keyword}{template} <\textcolor{keyword}{typename} MatrixType>
00029 \_\_attribute\_\_ ((noinline)) \textcolor{keywordtype}{void} benchLLT(\textcolor{keyword}{const} MatrixType& m)
00030 \{
00031   \textcolor{keywordtype}{int} rows = m.rows();
00032   \textcolor{keywordtype}{int} cols = m.cols();
00033 
00034   \textcolor{keywordtype}{double} cost = 0;
00035   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j=0; j<rows; ++j)
00036   \{
00037     \textcolor{keywordtype}{int} r = std::max(rows - j -1,0);
00038     cost += 2*(r*j+r+j);
00039   \}
00040 
00041   \textcolor{keywordtype}{int} repeats = (REPEAT*1000)/(rows*rows);
00042 
00043   \textcolor{keyword}{typedef} \textcolor{keyword}{typename} MatrixType::Scalar Scalar;
00044   \textcolor{keyword}{typedef} 
      \hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar, MatrixType::RowsAtCompileTime, MatrixType::RowsAtCompileTime>}
       SquareMatrixType;
00045 
00046   MatrixType a = MatrixType::Random(rows,cols);
00047   SquareMatrixType covMat =  a * a.adjoint();
00048 
00049   \hyperlink{class_eigen_1_1_bench_timer}{BenchTimer} timerNoSqrt, timerSqrt;
00050 
00051   Scalar acc = 0;
00052   \textcolor{keywordtype}{int} r = internal::random<int>(0,covMat.rows()-1);
00053   \textcolor{keywordtype}{int} c = internal::random<int>(0,covMat.cols()-1);
00054   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} t=0; t<TRIES; ++t)
00055   \{
00056     timerNoSqrt.start();
00057     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<repeats; ++k)
00058     \{
00059       \hyperlink{group___cholesky___module_class_eigen_1_1_l_d_l_t}{LDLT<SquareMatrixType>} cholnosqrt(covMat);
00060       acc += cholnosqrt.matrixL().coeff(r,c);
00061     \}
00062     timerNoSqrt.stop();
00063   \}
00064 
00065   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} t=0; t<TRIES; ++t)
00066   \{
00067     timerSqrt.start();
00068     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<repeats; ++k)
00069     \{
00070       \hyperlink{group___cholesky___module_class_eigen_1_1_l_l_t}{LLT<SquareMatrixType>} chol(covMat);
00071       acc += chol.matrixL().coeff(r,c);
00072     \}
00073     timerSqrt.stop();
00074   \}
00075 
00076   \textcolor{keywordflow}{if} (MatrixType::RowsAtCompileTime==\hyperlink{namespace_eigen_ad81fa7195215a0ce30017dfac309f0b2}{Dynamic})
00077     std::cout << \textcolor{stringliteral}{"dyn   "};
00078   \textcolor{keywordflow}{else}
00079     std::cout << \textcolor{stringliteral}{"fixed "};
00080   std::cout << covMat.rows() << \textcolor{stringliteral}{" \(\backslash\)t"}
00081             << (timerNoSqrt.\hyperlink{class_eigen_1_1_bench_timer_ae8b673b0fa356d3432c7a65c79e8af0e}{best}()) / repeats << \textcolor{stringliteral}{"s "}
00082             << \textcolor{stringliteral}{"("} << 1e-9 * cost*repeats/timerNoSqrt.\hyperlink{class_eigen_1_1_bench_timer_ae8b673b0fa356d3432c7a65c79e8af0e}{best}() << \textcolor{stringliteral}{" GFLOPS)\(\backslash\)t"}
00083             << (timerSqrt.\hyperlink{class_eigen_1_1_bench_timer_ae8b673b0fa356d3432c7a65c79e8af0e}{best}()) / repeats << \textcolor{stringliteral}{"s "}
00084             << \textcolor{stringliteral}{"("} << 1e-9 * cost*repeats/timerSqrt.\hyperlink{class_eigen_1_1_bench_timer_ae8b673b0fa356d3432c7a65c79e8af0e}{best}() << \textcolor{stringliteral}{" GFLOPS)\(\backslash\)n"};
00085 
00086 
00087 \textcolor{preprocessor}{  #ifdef BENCH\_GSL}
00088   \textcolor{keywordflow}{if} (MatrixType::RowsAtCompileTime==\hyperlink{namespace_eigen_ad81fa7195215a0ce30017dfac309f0b2}{Dynamic})
00089   \{
00090     timerSqrt.reset();
00091 
00092     gsl\_matrix* gslCovMat = gsl\_matrix\_alloc(covMat.rows(),covMat.cols());
00093     gsl\_matrix* gslCopy = gsl\_matrix\_alloc(covMat.rows(),covMat.cols());
00094 
00095     eiToGsl(covMat, &gslCovMat);
00096     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} t=0; t<TRIES; ++t)
00097     \{
00098       timerSqrt.start();
00099       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<repeats; ++k)
00100       \{
00101         gsl\_matrix\_memcpy(gslCopy,gslCovMat);
00102         gsl\_linalg\_cholesky\_decomp(gslCopy);
00103         acc += gsl\_matrix\_get(gslCopy,r,c);
00104       \}
00105       timerSqrt.stop();
00106     \}
00107 
00108     std::cout << \textcolor{stringliteral}{" | \(\backslash\)t"}
00109               << timerSqrt.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() * REPEAT / repeats << \textcolor{stringliteral}{"s"};
00110 
00111     gsl\_matrix\_free(gslCovMat);
00112   \}
00113 \textcolor{preprocessor}{  #endif}
00114   std::cout << \textcolor{stringliteral}{"\(\backslash\)n"};
00115   \textcolor{comment}{// make sure the compiler does not optimize too much}
00116   \textcolor{keywordflow}{if} (acc==123)
00117     std::cout << acc;
00118 \}
00119 
00120 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char}* argv[])
00121 \{
00122   \textcolor{keyword}{const} \textcolor{keywordtype}{int} dynsizes[] = \{4,6,8,16,24,32,49,64,128,256,512,900,1500,0\};
00123   std::cout << \textcolor{stringliteral}{"size            LDLT                            LLT"};
00124 \textcolor{comment}{//   #ifdef BENCH\_GSL}
00125 \textcolor{comment}{//   std::cout << "       GSL (standard + double + ATLAS)  ";}
00126 \textcolor{comment}{//   #endif}
00127   std::cout << \textcolor{stringliteral}{"\(\backslash\)n"};
00128   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=0; dynsizes[i]>0; ++i)
00129     benchLLT(\hyperlink{group___core___module}{Matrix<Scalar,Dynamic,Dynamic>}(dynsizes[i],dynsizes[i]));
00130 
00131   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,2,2>}());
00132   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,3,3>}());
00133   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,4,4>}());
00134   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,5,5>}());
00135   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,6,6>}());
00136   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,7,7>}());
00137   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,8,8>}());
00138   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,12,12>}());
00139   benchLLT(\hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,16,16>}());
00140   \textcolor{keywordflow}{return} 0;
00141 \}
00142 
\end{DoxyCode}
