\hypertarget{matio_2visual__studio_2test_2eigen_2bench_2bench_vec_add_8cpp_source}{}\section{matio/visual\+\_\+studio/test/eigen/bench/bench\+Vec\+Add.cpp}
\label{matio_2visual__studio_2test_2eigen_2bench_2bench_vec_add_8cpp_source}\index{bench\+Vec\+Add.\+cpp@{bench\+Vec\+Add.\+cpp}}

\begin{DoxyCode}
00001 
00002 \textcolor{preprocessor}{#include <iostream>}
00003 \textcolor{preprocessor}{#include <Eigen/Core>}
00004 \textcolor{preprocessor}{#include <bench/BenchTimer.h>}
00005 \textcolor{keyword}{using namespace }\hyperlink{namespace_eigen}{Eigen};
00006 
00007 \textcolor{preprocessor}{#ifndef SIZE}
00008 \textcolor{preprocessor}{#define SIZE 50}
00009 \textcolor{preprocessor}{#endif}
00010 
00011 \textcolor{preprocessor}{#ifndef REPEAT}
00012 \textcolor{preprocessor}{#define REPEAT 10000}
00013 \textcolor{preprocessor}{#endif}
00014 
00015 \textcolor{keyword}{typedef} \textcolor{keywordtype}{float} Scalar;
00016 
00017 \_\_attribute\_\_ ((noinline)) \textcolor{keywordtype}{void} benchVec(Scalar* a, Scalar* b, Scalar* c, \textcolor{keywordtype}{int} size);
00018 \_\_attribute\_\_ ((noinline)) \textcolor{keywordtype}{void} benchVec(MatrixXf& a, MatrixXf& b, MatrixXf& c);
00019 \_\_attribute\_\_ ((noinline)) \textcolor{keywordtype}{void} benchVec(VectorXf& a, VectorXf& b, VectorXf& c);
00020 
00021 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char}* argv[])
00022 \{
00023     \textcolor{keywordtype}{int} size = SIZE * 8;
00024     \textcolor{keywordtype}{int} size2 = size * size;
00025     Scalar* a = internal::aligned\_new<Scalar>(size2);
00026     Scalar* b = internal::aligned\_new<Scalar>(size2+4)+1;
00027     Scalar* c = internal::aligned\_new<Scalar>(size2); 
00028     
00029     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=0; i<size; ++i)
00030     \{
00031         a[i] = b[i] = c[i] = 0;
00032     \}
00033     
00034     \hyperlink{class_eigen_1_1_bench_timer}{BenchTimer} timer;
00035     
00036     timer.reset();
00037     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<10; ++k)
00038     \{
00039         timer.start();
00040         benchVec(a, b, c, size2);
00041         timer.stop();
00042     \}
00043     std::cout << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << \textcolor{stringliteral}{"s  "} << (double(size2*REPEAT)/timer.
      \hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}())/(1024.*1024.*1024.) << \textcolor{stringliteral}{" GFlops\(\backslash\)n"};
00044     \textcolor{keywordflow}{return} 0;
00045     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} innersize = size; innersize>2 ; --innersize)
00046     \{
00047         \textcolor{keywordflow}{if} (size2%innersize==0)
00048         \{
00049             \textcolor{keywordtype}{int} outersize = size2/innersize;
00050             MatrixXf ma = \hyperlink{group___core___module_class_eigen_1_1_map}{Map<MatrixXf>}(a, innersize, outersize );
00051             MatrixXf mb = \hyperlink{group___core___module_class_eigen_1_1_map}{Map<MatrixXf>}(b, innersize, outersize );
00052             MatrixXf mc = \hyperlink{group___core___module_class_eigen_1_1_map}{Map<MatrixXf>}(c, innersize, outersize );
00053             timer.reset();
00054             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<3; ++k)
00055             \{
00056                 timer.start();
00057                 benchVec(ma, mb, mc);
00058                 timer.stop();
00059             \}
00060             std::cout << innersize << \textcolor{stringliteral}{" x "} << outersize << \textcolor{stringliteral}{"  "} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << \textcolor{stringliteral}{"s   "} << (double
      (size2*REPEAT)/timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}())/(1024.*1024.*1024.) << \textcolor{stringliteral}{" GFlops\(\backslash\)n"};
00061         \}
00062     \}
00063     
00064     VectorXf va = \hyperlink{group___core___module_class_eigen_1_1_map}{Map<VectorXf>}(a, size2);
00065     VectorXf vb = \hyperlink{group___core___module_class_eigen_1_1_map}{Map<VectorXf>}(b, size2);
00066     VectorXf vc = \hyperlink{group___core___module_class_eigen_1_1_map}{Map<VectorXf>}(c, size2);
00067     timer.reset();
00068     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<3; ++k)
00069     \{
00070         timer.start();
00071         benchVec(va, vb, vc);
00072         timer.stop();
00073     \}
00074     std::cout << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << \textcolor{stringliteral}{"s   "} << (double(size2*REPEAT)/timer.
      \hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}())/(1024.*1024.*1024.) << \textcolor{stringliteral}{" GFlops\(\backslash\)n"};
00075 
00076     \textcolor{keywordflow}{return} 0;
00077 \}
00078 
00079 \textcolor{keywordtype}{void} benchVec(MatrixXf& a, MatrixXf& b, MatrixXf& c)
00080 \{
00081     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<REPEAT; ++k)
00082         a = a + b;
00083 \}
00084 
00085 \textcolor{keywordtype}{void} benchVec(VectorXf& a, VectorXf& b, VectorXf& c)
00086 \{
00087     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<REPEAT; ++k)
00088         a = a + b;
00089 \}
00090 
00091 \textcolor{keywordtype}{void} benchVec(Scalar* a, Scalar* b, Scalar* c, \textcolor{keywordtype}{int} size)
00092 \{
00093     \textcolor{keyword}{typedef} \hyperlink{group___sparse_core___module}{internal::packet\_traits<Scalar>::type} PacketScalar;
00094     \textcolor{keyword}{const} \textcolor{keywordtype}{int} PacketSize = internal::packet\_traits<Scalar>::size;
00095     PacketScalar a0, a1, a2, a3, b0, b1, b2, b3;
00096     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} k=0; k<REPEAT; ++k)
00097         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=0; i<size; i+=PacketSize*8)
00098         \{
00099 \textcolor{comment}{//             a0 = internal::pload(&a[i]);}
00100 \textcolor{comment}{//             b0 = internal::pload(&b[i]);}
00101 \textcolor{comment}{//             a1 = internal::pload(&a[i+1*PacketSize]);}
00102 \textcolor{comment}{//             b1 = internal::pload(&b[i+1*PacketSize]);}
00103 \textcolor{comment}{//             a2 = internal::pload(&a[i+2*PacketSize]);}
00104 \textcolor{comment}{//             b2 = internal::pload(&b[i+2*PacketSize]);}
00105 \textcolor{comment}{//             a3 = internal::pload(&a[i+3*PacketSize]);}
00106 \textcolor{comment}{//             b3 = internal::pload(&b[i+3*PacketSize]);}
00107 \textcolor{comment}{//             internal::pstore(&a[i], internal::padd(a0, b0));}
00108 \textcolor{comment}{//             a0 = internal::pload(&a[i+4*PacketSize]);}
00109 \textcolor{comment}{//             b0 = internal::pload(&b[i+4*PacketSize]);}
00110 \textcolor{comment}{//             }
00111 \textcolor{comment}{//             internal::pstore(&a[i+1*PacketSize], internal::padd(a1, b1));}
00112 \textcolor{comment}{//             a1 = internal::pload(&a[i+5*PacketSize]);}
00113 \textcolor{comment}{//             b1 = internal::pload(&b[i+5*PacketSize]);}
00114 \textcolor{comment}{//             }
00115 \textcolor{comment}{//             internal::pstore(&a[i+2*PacketSize], internal::padd(a2, b2));}
00116 \textcolor{comment}{//             a2 = internal::pload(&a[i+6*PacketSize]);}
00117 \textcolor{comment}{//             b2 = internal::pload(&b[i+6*PacketSize]);}
00118 \textcolor{comment}{//             }
00119 \textcolor{comment}{//             internal::pstore(&a[i+3*PacketSize], internal::padd(a3, b3));}
00120 \textcolor{comment}{//             a3 = internal::pload(&a[i+7*PacketSize]);}
00121 \textcolor{comment}{//             b3 = internal::pload(&b[i+7*PacketSize]);}
00122 \textcolor{comment}{//             }
00123 \textcolor{comment}{//             internal::pstore(&a[i+4*PacketSize], internal::padd(a0, b0));}
00124 \textcolor{comment}{//             internal::pstore(&a[i+5*PacketSize], internal::padd(a1, b1));}
00125 \textcolor{comment}{//             internal::pstore(&a[i+6*PacketSize], internal::padd(a2, b2));}
00126 \textcolor{comment}{//             internal::pstore(&a[i+7*PacketSize], internal::padd(a3, b3));}
00127             
00128             internal::pstore(&a[i+2*PacketSize], internal::padd(internal::ploadu(&a[i+2*PacketSize]), 
      internal::ploadu(&b[i+2*PacketSize])));
00129             internal::pstore(&a[i+3*PacketSize], internal::padd(internal::ploadu(&a[i+3*PacketSize]), 
      internal::ploadu(&b[i+3*PacketSize])));
00130             internal::pstore(&a[i+4*PacketSize], internal::padd(internal::ploadu(&a[i+4*PacketSize]), 
      internal::ploadu(&b[i+4*PacketSize])));
00131             internal::pstore(&a[i+5*PacketSize], internal::padd(internal::ploadu(&a[i+5*PacketSize]), 
      internal::ploadu(&b[i+5*PacketSize])));
00132             internal::pstore(&a[i+6*PacketSize], internal::padd(internal::ploadu(&a[i+6*PacketSize]), 
      internal::ploadu(&b[i+6*PacketSize])));
00133             internal::pstore(&a[i+7*PacketSize], internal::padd(internal::ploadu(&a[i+7*PacketSize]), 
      internal::ploadu(&b[i+7*PacketSize])));
00134         \}
00135 \}
\end{DoxyCode}
