\hypertarget{matio_2visual__studio_2test_2eigen_2test_2sparse__ref_8cpp_source}{}\section{matio/visual\+\_\+studio/test/eigen/test/sparse\+\_\+ref.cpp}
\label{matio_2visual__studio_2test_2eigen_2test_2sparse__ref_8cpp_source}\index{sparse\+\_\+ref.\+cpp@{sparse\+\_\+ref.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of Eigen, a lightweight C++ template library}
00002 \textcolor{comment}{// for linear algebra.}
00003 \textcolor{comment}{//}
00004 \textcolor{comment}{// Copyright (C) 20015 Gael Guennebaud <gael.guennebaud@inria.fr>}
00005 \textcolor{comment}{//}
00006 \textcolor{comment}{// This Source Code Form is subject to the terms of the Mozilla}
00007 \textcolor{comment}{// Public License v. 2.0. If a copy of the MPL was not distributed}
00008 \textcolor{comment}{// with this file, You can obtain one at http://mozilla.org/MPL/2.0/.}
00009 
00010 \textcolor{comment}{// This unit test cannot be easily written to work with EIGEN\_DEFAULT\_TO\_ROW\_MAJOR}
00011 \textcolor{preprocessor}{#ifdef EIGEN\_DEFAULT\_TO\_ROW\_MAJOR}
00012 \textcolor{preprocessor}{#undef EIGEN\_DEFAULT\_TO\_ROW\_MAJOR}
00013 \textcolor{preprocessor}{#endif}
00014 
00015 \textcolor{keyword}{static} \textcolor{keywordtype}{long} \textcolor{keywordtype}{int} nb\_temporaries;
00016 
00017 \textcolor{keyword}{inline} \textcolor{keywordtype}{void} on\_temporary\_creation() \{
00018   \textcolor{comment}{// here's a great place to set a breakpoint when debugging failures in this test!}
00019   nb\_temporaries++;
00020 \}
00021 
00022 \textcolor{preprocessor}{#define EIGEN\_SPARSE\_CREATE\_TEMPORARY\_PLUGIN \{ on\_temporary\_creation(); \}}
00023 
00024 \textcolor{preprocessor}{#include "main.h"}
00025 \textcolor{preprocessor}{#include <Eigen/SparseCore>}
00026 
00027 \textcolor{preprocessor}{#define VERIFY\_EVALUATION\_COUNT(XPR,N) \{\(\backslash\)}
00028 \textcolor{preprocessor}{    nb\_temporaries = 0; \(\backslash\)}
00029 \textcolor{preprocessor}{    CALL\_SUBTEST( XPR ); \(\backslash\)}
00030 \textcolor{preprocessor}{    if(nb\_temporaries!=N) std::cerr << "nb\_temporaries == " << nb\_temporaries << "\(\backslash\)n"; \(\backslash\)}
00031 \textcolor{preprocessor}{    VERIFY( (#XPR) && nb\_temporaries==N ); \(\backslash\)}
00032 \textcolor{preprocessor}{  \}}
00033 
00034 \textcolor{keyword}{template}<\textcolor{keyword}{typename} PlainObjectType> \textcolor{keywordtype}{void} check\_const\_correctness(\textcolor{keyword}{const} PlainObjectType&)
00035 \{
00036   \textcolor{comment}{// verify that ref-to-const don't have LvalueBit}
00037   \textcolor{keyword}{typedef} \textcolor{keyword}{typename} \hyperlink{group___core___module_class_eigen_1_1_transpose}{internal::add\_const<PlainObjectType>::type} 
      ConstPlainObjectType;
00038   VERIFY( !(internal::traits<\hyperlink{group___core___module_class_eigen_1_1_ref}{Ref<ConstPlainObjectType>} >::Flags & 
      \hyperlink{group__flags_gae2c323957f20dfdc6cb8f44428eaec1a}{LvalueBit}) );
00039   VERIFY( !(internal::traits<\hyperlink{group___core___module_class_eigen_1_1_ref}{Ref<ConstPlainObjectType, Aligned>} >::Flags 
      & \hyperlink{group__flags_gae2c323957f20dfdc6cb8f44428eaec1a}{LvalueBit}) );
00040   VERIFY( !(\hyperlink{group___core___module_class_eigen_1_1_ref}{Ref<ConstPlainObjectType>::Flags} & 
      \hyperlink{group__flags_gae2c323957f20dfdc6cb8f44428eaec1a}{LvalueBit}) );
00041   VERIFY( !(\hyperlink{group___core___module_class_eigen_1_1_ref}{Ref<ConstPlainObjectType, Aligned>::Flags} & 
      \hyperlink{group__flags_gae2c323957f20dfdc6cb8f44428eaec1a}{LvalueBit}) );
00042 \}
00043 
00044 \textcolor{keyword}{template}<\textcolor{keyword}{typename} B>
00045 EIGEN\_DONT\_INLINE \textcolor{keywordtype}{void} call\_ref\_1(\hyperlink{group___core___module_class_eigen_1_1_ref}{Ref}<\hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float>} > a, \textcolor{keyword}{const} 
      \hyperlink{group___core___module_class_eigen_1_1_matrix}{B} &b) \{ VERIFY\_IS\_EQUAL(a.toDense(),b.toDense()); \}
00046 
00047 \textcolor{keyword}{template}<\textcolor{keyword}{typename} B>
00048 EIGEN\_DONT\_INLINE \textcolor{keywordtype}{void} call\_ref\_2(\textcolor{keyword}{const} \hyperlink{group___core___module_class_eigen_1_1_ref}{Ref}<\textcolor{keyword}{const} \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float>} >& a, \textcolor{keyword}{const} 
      \hyperlink{group___core___module_class_eigen_1_1_matrix}{B} &b) \{ VERIFY\_IS\_EQUAL(a.toDense(),b.toDense()); \}
00049 
00050 \textcolor{keyword}{template}<\textcolor{keyword}{typename} B>
00051 EIGEN\_DONT\_INLINE \textcolor{keywordtype}{void} call\_ref\_3(\textcolor{keyword}{const} \hyperlink{group___core___module_class_eigen_1_1_ref}{Ref}<\textcolor{keyword}{const} \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float>}, 
      StandardCompressedFormat>& a, \textcolor{keyword}{const} \hyperlink{group___core___module_class_eigen_1_1_matrix}{B} &b) \{
00052   VERIFY(a.isCompressed());
00053   VERIFY\_IS\_EQUAL(a.toDense(),b.toDense());
00054 \}
00055 
00056 \textcolor{keyword}{template}<\textcolor{keyword}{typename} B>
00057 EIGEN\_DONT\_INLINE \textcolor{keywordtype}{void} call\_ref\_4(\hyperlink{group___core___module_class_eigen_1_1_ref}{Ref}<\hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_vector}{SparseVector<float>} > a, \textcolor{keyword}{const} 
      \hyperlink{group___core___module_class_eigen_1_1_matrix}{B} &b) \{ VERIFY\_IS\_EQUAL(a.toDense(),b.toDense()); \}
00058 
00059 \textcolor{keyword}{template}<\textcolor{keyword}{typename} B>
00060 EIGEN\_DONT\_INLINE \textcolor{keywordtype}{void} call\_ref\_5(\textcolor{keyword}{const} \hyperlink{group___core___module_class_eigen_1_1_ref}{Ref}<\textcolor{keyword}{const} \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_vector}{SparseVector<float>} >& a, \textcolor{keyword}{const} 
      \hyperlink{group___core___module_class_eigen_1_1_matrix}{B} &b) \{ VERIFY\_IS\_EQUAL(a.toDense(),b.toDense()); \}
00061 
00062 \textcolor{keywordtype}{void} call\_ref()
00063 \{
00064   \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float>}               \hyperlink{group___core___module_class_eigen_1_1_matrix}{A} = MatrixXf::Random(10,10).sparseView(0.5,1);
00065   \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float,RowMajor>}      \hyperlink{group___core___module_class_eigen_1_1_matrix}{B} = MatrixXf::Random(10,10).sparseView(0.5
      ,1);
00066   \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float>}               \hyperlink{group___core___module}{C} = MatrixXf::Random(10,10).sparseView(0.5,1);
00067   C.\hyperlink{group___sparse_core___module_a1518e58ac49bed0e2385b722a034f7d3}{reserve}(VectorXi::Constant(C.\hyperlink{group___sparse_core___module_a4e5f706cfae14d2eaec1ea1e234905f1}{outerSize}(), 2));
00068   \textcolor{keyword}{const} \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float>}&        Ac(A);
00069   \hyperlink{group___core___module_class_eigen_1_1_block}{Block<SparseMatrix<float>} >       Ab(A,0,1, 3,3);
00070   \textcolor{keyword}{const} \hyperlink{group___core___module_class_eigen_1_1_block}{Block<SparseMatrix<float>} > Abc(A,0,1,3,3);
00071   \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_vector}{SparseVector<float>}               vc =  VectorXf::Random(10).sparseView(0.5,1);
00072   \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_vector}{SparseVector<float,RowMajor>}      vr =  VectorXf::Random(10).sparseView(0.5,1
      );
00073   \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float>} AA = A*A;
00074   
00075 
00076   VERIFY\_EVALUATION\_COUNT( call\_ref\_1(A, A),  0);
00077 \textcolor{comment}{//   VERIFY\_EVALUATION\_COUNT( call\_ref\_1(Ac, Ac),  0); // does not compile on purpose}
00078   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(A, A),  0);
00079   VERIFY\_EVALUATION\_COUNT( call\_ref\_3(A, A),  0);
00080   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(A.transpose(), A.transpose()),  1);
00081   VERIFY\_EVALUATION\_COUNT( call\_ref\_3(A.transpose(), A.transpose()),  1);
00082   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(Ac,Ac), 0);
00083   VERIFY\_EVALUATION\_COUNT( call\_ref\_3(Ac,Ac), 0);
00084   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(A+A,2*Ac), 1);
00085   VERIFY\_EVALUATION\_COUNT( call\_ref\_3(A+A,2*Ac), 1);
00086   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(B, B),  1);
00087   VERIFY\_EVALUATION\_COUNT( call\_ref\_3(B, B),  1);
00088   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(B.transpose(), B.transpose()),  0);
00089   VERIFY\_EVALUATION\_COUNT( call\_ref\_3(B.transpose(), B.transpose()),  0);
00090   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(A*A, AA),  3);
00091   VERIFY\_EVALUATION\_COUNT( call\_ref\_3(A*A, AA),  3);
00092   
00093   VERIFY(!C.\hyperlink{group___sparse_core___module_a837934b33a80fe996ff20500373d3a61}{isCompressed}());
00094   VERIFY\_EVALUATION\_COUNT( call\_ref\_3(C, C),  1);
00095   
00096   \hyperlink{group___core___module_class_eigen_1_1_ref}{Ref<SparseMatrix<float>} > Ar(A);
00097   VERIFY\_IS\_APPROX(Ar+Ar, A+A);
00098   VERIFY\_EVALUATION\_COUNT( call\_ref\_1(Ar, A),  0);
00099   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(Ar, A),  0);
00100   
00101   \hyperlink{group___core___module_class_eigen_1_1_ref}{Ref<SparseMatrix<float,RowMajor>} > Br(B);
00102   VERIFY\_EVALUATION\_COUNT( call\_ref\_1(Br.transpose(), Br.transpose()),  0);
00103   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(Br, Br),  1);
00104   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(Br.transpose(), Br.transpose()),  0);
00105   
00106   \hyperlink{group___core___module_class_eigen_1_1_ref}{Ref<const SparseMatrix<float>} > Arc(A);
00107 \textcolor{comment}{//   VERIFY\_EVALUATION\_COUNT( call\_ref\_1(Arc, Arc),  0); // does not compile on purpose}
00108   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(Arc, Arc),  0);
00109   
00110   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(A.middleCols(1,3), A.middleCols(1,3)),  0);
00111   
00112   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(A.col(2), A.col(2)),  0);
00113   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(vc, vc),  0);
00114   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(vr.transpose(), vr.transpose()),  0);
00115   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(vr, vr.transpose()),  0);
00116   
00117   VERIFY\_EVALUATION\_COUNT( call\_ref\_2(A.block(1,1,3,3), A.block(1,1,3,3)),  1); \textcolor{comment}{// should be 0 (allocate
       starts/nnz only)}
00118 
00119   VERIFY\_EVALUATION\_COUNT( call\_ref\_4(vc, vc),  0);
00120   VERIFY\_EVALUATION\_COUNT( call\_ref\_4(vr, vr.transpose()),  0);
00121   VERIFY\_EVALUATION\_COUNT( call\_ref\_5(vc, vc),  0);
00122   VERIFY\_EVALUATION\_COUNT( call\_ref\_5(vr, vr.transpose()),  0);
00123   VERIFY\_EVALUATION\_COUNT( call\_ref\_4(A.col(2), A.col(2)),  0);
00124   VERIFY\_EVALUATION\_COUNT( call\_ref\_5(A.col(2), A.col(2)),  0);
00125   \textcolor{comment}{// VERIFY\_EVALUATION\_COUNT( call\_ref\_4(A.row(2), A.row(2).transpose()),  1); // does not compile on
       purpose}
00126   VERIFY\_EVALUATION\_COUNT( call\_ref\_5(A.row(2), A.row(2).transpose()),  1);
00127 \}
00128 
00129 \textcolor{keywordtype}{void} test\_sparse\_ref()
00130 \{
00131   \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < g\_repeat; i++) \{
00132     CALL\_SUBTEST\_1( check\_const\_correctness(\hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<float>}()) );
00133     CALL\_SUBTEST\_1( check\_const\_correctness(\hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<double,RowMajor>}()) )
      ;
00134     CALL\_SUBTEST\_2( call\_ref() );
00135 
00136     CALL\_SUBTEST\_3( check\_const\_correctness(\hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_vector}{SparseVector<float>}()) );
00137     CALL\_SUBTEST\_3( check\_const\_correctness(\hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_vector}{SparseVector<double,RowMajor>}()) )
      ;
00138   \}
00139 \}
\end{DoxyCode}
