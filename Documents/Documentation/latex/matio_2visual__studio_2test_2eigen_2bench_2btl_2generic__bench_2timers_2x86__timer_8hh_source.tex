\hypertarget{matio_2visual__studio_2test_2eigen_2bench_2btl_2generic__bench_2timers_2x86__timer_8hh_source}{}\section{matio/visual\+\_\+studio/test/eigen/bench/btl/generic\+\_\+bench/timers/x86\+\_\+timer.hh}
\label{matio_2visual__studio_2test_2eigen_2bench_2btl_2generic__bench_2timers_2x86__timer_8hh_source}\index{x86\+\_\+timer.\+hh@{x86\+\_\+timer.\+hh}}

\begin{DoxyCode}
00001 \textcolor{comment}{//=====================================================}
00002 \textcolor{comment}{// File   :  x86\_timer.hh}
00003 \textcolor{comment}{// Author :  L. Plagne <laurent.plagne@edf.fr)>        }
00004 \textcolor{comment}{// Copyright (C) EDF R&D,  mar dï¿½c 3 18:59:35 CET 2002}
00005 \textcolor{comment}{//=====================================================}
00006 \textcolor{comment}{// }
00007 \textcolor{comment}{// This program is free software; you can redistribute it and/or}
00008 \textcolor{comment}{// modify it under the terms of the GNU General Public License}
00009 \textcolor{comment}{// as published by the Free Software Foundation; either version 2}
00010 \textcolor{comment}{// of the License, or (at your option) any later version.}
00011 \textcolor{comment}{// }
00012 \textcolor{comment}{// This program is distributed in the hope that it will be useful,}
00013 \textcolor{comment}{// but WITHOUT ANY WARRANTY; without even the implied warranty of}
00014 \textcolor{comment}{// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00015 \textcolor{comment}{// GNU General Public License for more details.}
00016 \textcolor{comment}{// You should have received a copy of the GNU General Public License}
00017 \textcolor{comment}{// along with this program; if not, write to the Free Software}
00018 \textcolor{comment}{// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.}
00019 \textcolor{comment}{// }
00020 \textcolor{preprocessor}{#ifndef \_X86\_TIMER\_HH}
00021 \textcolor{preprocessor}{#define \_X86\_TIMER\_HH}
00022 
00023 \textcolor{preprocessor}{#include <sys/time.h>}
00024 \textcolor{preprocessor}{#include <sys/resource.h>}
00025 \textcolor{preprocessor}{#include <unistd.h>}
00026 \textcolor{preprocessor}{#include <sys/times.h>}
00027 \textcolor{comment}{//#include "system\_time.h"}
00028 \textcolor{preprocessor}{#define u32 unsigned int}
00029 \textcolor{preprocessor}{#include <asm/msr.h>}
00030 \textcolor{preprocessor}{#include "utilities.h"}
00031 \textcolor{preprocessor}{#include <map>}
00032 \textcolor{preprocessor}{#include <fstream>}
00033 \textcolor{preprocessor}{#include <string>}
00034 \textcolor{preprocessor}{#include <iostream>}
00035 
00036 \textcolor{comment}{// frequence de la becanne en Hz}
00037 \textcolor{comment}{//#define FREQUENCY 648000000}
00038 \textcolor{comment}{//#define FREQUENCY 1400000000}
00039 \textcolor{preprocessor}{#define FREQUENCY 1695000000}
00040 
00041 \textcolor{keyword}{using namespace }\hyperlink{namespacestd}{std};
00042 
00043 
00044 \textcolor{keyword}{class }\hyperlink{class_x86___timer}{X86\_Timer} \{
00045 
00046 public :
00047 
00048   \hyperlink{class_x86___timer}{X86\_Timer}( \textcolor{keywordtype}{void} ):\_frequency(FREQUENCY),\_nb\_sample(0)
00049   \{
00050     MESSAGE(\textcolor{stringliteral}{"X86\_Timer Default Ctor"});    
00051   \}
00052 
00053   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} start( \textcolor{keywordtype}{void} )\{
00054 
00055     rdtsc(\_click\_start.n32[0],\_click\_start.n32[1]);
00056 
00057   \}
00058 
00059 
00060   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} stop( \textcolor{keywordtype}{void} )\{
00061 
00062     rdtsc(\_click\_stop.n32[0],\_click\_stop.n32[1]);
00063 
00064   \}
00065   
00066 
00067   \textcolor{keyword}{inline} \textcolor{keywordtype}{double} frequency( \textcolor{keywordtype}{void} )\{
00068     \textcolor{keywordflow}{return} \_frequency;
00069   \}
00070 
00071   \textcolor{keywordtype}{double} get\_elapsed\_time\_in\_second( \textcolor{keywordtype}{void} )\{
00072 
00073     \textcolor{keywordflow}{return} (\_click\_stop.n64-\_click\_start.n64)/double(FREQUENCY);
00074 
00075 
00076   \}    
00077 
00078   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long}  get\_click( \textcolor{keywordtype}{void} )\{
00079     
00080     \textcolor{keywordflow}{return} (\_click\_stop.n64-\_click\_start.n64);
00081 
00082   \}    
00083 
\Hypertarget{matio_2visual__studio_2test_2eigen_2bench_2btl_2generic__bench_2timers_2x86__timer_8hh_source_l00084}\hyperlink{class_x86___timer_a1beddd8cb10ed89d3dd06d3b233b63e1}{00084}   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} \hyperlink{class_x86___timer_a1beddd8cb10ed89d3dd06d3b233b63e1}{find\_frequency}( \textcolor{keywordtype}{void} )\{
00085 
00086     time\_t initial, \textcolor{keyword}{final};
00087     \textcolor{keywordtype}{int} dummy=2;
00088 
00089     initial = time(0);
00090     start();
00091     \textcolor{keywordflow}{do} \{
00092       dummy+=2;
00093     \}
00094     \textcolor{keywordflow}{while}(time(0)==initial);
00095     \textcolor{comment}{// On est au debut d'un cycle d'une seconde !!!}
00096     initial = time(0);
00097     start();
00098     \textcolor{keywordflow}{do} \{
00099       dummy+=2;
00100     \}
00101     \textcolor{keywordflow}{while}(time(0)==initial);
00102     \textcolor{keyword}{final}=time(0);
00103     stop();
00104     \textcolor{comment}{//    INFOS("fine grained time : "<<  get\_elapsed\_time\_in\_second());}
00105     \textcolor{comment}{//  INFOS("coarse grained time : "<<  final-initial);}
00106     \_frequency=\_frequency*get\_elapsed\_time\_in\_second()/double(\textcolor{keyword}{final}-initial);
00108 
00109   \}
00110 
00111   \textcolor{keywordtype}{void}  add\_get\_click( \textcolor{keywordtype}{void} )\{
00112        
00113     \_nb\_sample++;
00114     \_counted\_clicks[get\_click()]++;
00115     fill\_history\_clicks();
00116 
00117   \}    
00118 
00119   \textcolor{keywordtype}{void} dump\_statistics(\textcolor{keywordtype}{string} filemane)\{
00120     
00121     ofstream outfile (filemane.c\_str(),ios::out) ;
00122 
00123     std::map<unsigned long long , unsigned long long>::iterator itr;
00124     \textcolor{keywordflow}{for}(itr=\_counted\_clicks.begin() ; itr!=\_counted\_clicks.end()  ; itr++)
00125       \{      
00126       outfile  << (*itr).first << \textcolor{stringliteral}{"  "} << (*itr).second << endl ;       
00127       \}      
00128     
00129     outfile.close();
00130 
00131   \}
00132 
00133   \textcolor{keywordtype}{void} dump\_history(\textcolor{keywordtype}{string} filemane)\{
00134     
00135     ofstream outfile (filemane.c\_str(),ios::out) ;
00136 
00137 
00138 
00139     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i=0 ; i<\_history\_mean\_clicks.size() ; i++)
00140       \{      
00141     outfile  << i << \textcolor{stringliteral}{" "} 
00142          << \_history\_mean\_clicks[i] << \textcolor{stringliteral}{" "} 
00143          << \_history\_shortest\_clicks[i] << \textcolor{stringliteral}{" "} 
00144          << \_history\_most\_occured\_clicks[i] << endl ;
00145       \}      
00146     
00147     outfile.close();
00148 
00149   \}
00150      
00151 
00152 
00153   \textcolor{keywordtype}{double} get\_mean\_clicks( \textcolor{keywordtype}{void} )\{
00154     
00155     std::map<unsigned long long,unsigned long long>::iterator itr;
00156     
00157     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} mean\_clicks=0;
00158 
00159     \textcolor{keywordflow}{for}(itr=\_counted\_clicks.begin() ; itr!=\_counted\_clicks.end()  ; itr++)
00160       \{      
00161     
00162     mean\_clicks+=(*itr).second*(*itr).first;
00163       \}      
00164 
00165     \textcolor{keywordflow}{return} mean\_clicks/double(\_nb\_sample);
00166 
00167   \}
00168 
00169   \textcolor{keywordtype}{double} get\_shortest\_clicks( \textcolor{keywordtype}{void} )\{
00170     
00171     \textcolor{keywordflow}{return} double((*\_counted\_clicks.begin()).first);
00172 
00173   \}
00174 
00175   \textcolor{keywordtype}{void} fill\_history\_clicks( \textcolor{keywordtype}{void} )\{
00176 
00177     \_history\_mean\_clicks.push\_back(get\_mean\_clicks());
00178     \_history\_shortest\_clicks.push\_back(get\_shortest\_clicks());
00179     \_history\_most\_occured\_clicks.push\_back(get\_most\_occured\_clicks());
00180 
00181   \}
00182 
00183 
00184   \textcolor{keywordtype}{double} get\_most\_occured\_clicks( \textcolor{keywordtype}{void} )\{
00185 
00186     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} moc=0;
00187     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} max\_occurence=0;
00188 
00189     std::map<unsigned long long,unsigned long long>::iterator itr;
00190 
00191     \textcolor{keywordflow}{for}(itr=\_counted\_clicks.begin() ; itr!=\_counted\_clicks.end()  ; itr++)
00192       \{      
00193     
00194     \textcolor{keywordflow}{if} (max\_occurence<=(*itr).second)\{
00195       max\_occurence=(*itr).second;
00196       moc=(*itr).first;
00197     \}
00198       \}      
00199     
00200     \textcolor{keywordflow}{return} double(moc);    
00201 
00202   \}
00203   
00204   \textcolor{keywordtype}{void} clear( \textcolor{keywordtype}{void} )
00205   \{
00206     \_counted\_clicks.clear();
00207 
00208     \_history\_mean\_clicks.clear();
00209     \_history\_shortest\_clicks.clear();
00210     \_history\_most\_occured\_clicks.clear();
00211 
00212     \_nb\_sample=0;
00213   \}
00214 
00215 
00216     
00217 private :
00218   
00219   \textcolor{keyword}{union}
00220   \{
00221     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{int} n32[2] ;
00222     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} n64 ;
00223   \} \_click\_start;
00224 
00225   \textcolor{keyword}{union}
00226   \{
00227     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{int} n32[2] ;
00228     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} n64 ;
00229   \} \_click\_stop;
00230 
00231   \textcolor{keywordtype}{double} \_frequency ;
00232 
00233   map<unsigned long long,unsigned long long> \_counted\_clicks;
00234 
00235   vector<double> \_history\_mean\_clicks;
00236   vector<double> \_history\_shortest\_clicks;
00237   vector<double> \_history\_most\_occured\_clicks;
00238 
00239   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \_nb\_sample;
00240 
00241   
00242 
00243 \};
00244 
00245 
00246 \textcolor{preprocessor}{#endif}
\end{DoxyCode}
