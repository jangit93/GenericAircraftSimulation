\hypertarget{visual__studio_2zlib_2contrib_2iostream_2zfstream_8cpp_source}{}\section{visual\+\_\+studio/zlib/contrib/iostream/zfstream.cpp}
\label{visual__studio_2zlib_2contrib_2iostream_2zfstream_8cpp_source}\index{zfstream.\+cpp@{zfstream.\+cpp}}

\begin{DoxyCode}
00001 
00002 \textcolor{preprocessor}{#include "zfstream.h"}
00003 
00004 gzfilebuf::gzfilebuf() :
00005   \hyperlink{structfile}{file}(NULL),
00006   mode(0),
00007   own\_file\_descriptor(0)
00008 \{ \}
00009 
00010 gzfilebuf::~gzfilebuf() \{
00011 
00012   sync();
00013   \textcolor{keywordflow}{if} ( own\_file\_descriptor )
00014     \hyperlink{classgzofstream_a59e8b01e1c9741085f18ca456c4b8f54}{close}();
00015 
00016 \}
00017 
00018 \hyperlink{classgzfilebuf}{gzfilebuf} *gzfilebuf::open( \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name,
00019                             \textcolor{keywordtype}{int} io\_mode ) \{
00020 
00021   \textcolor{keywordflow}{if} ( \hyperlink{classgzofstream_acb1c9c6dccaf41bc5e44c2263ea48de3}{is\_open}() )
00022     \textcolor{keywordflow}{return} NULL;
00023 
00024   \textcolor{keywordtype}{char} char\_mode[10];
00025   \textcolor{keywordtype}{char} *p = char\_mode;
00026 
00027   \textcolor{keywordflow}{if} ( io\_mode & ios::in ) \{
00028     mode = ios::in;
00029     *p++ = \textcolor{charliteral}{'r'};
00030   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( io\_mode & ios::app ) \{
00031     mode = ios::app;
00032     *p++ = \textcolor{charliteral}{'a'};
00033   \} \textcolor{keywordflow}{else} \{
00034     mode = ios::out;
00035     *p++ = \textcolor{charliteral}{'w'};
00036   \}
00037 
00038   \textcolor{keywordflow}{if} ( io\_mode & ios::binary ) \{
00039     mode |= ios::binary;
00040     *p++ = \textcolor{charliteral}{'b'};
00041   \}
00042 
00043   \textcolor{comment}{// Hard code the compression level}
00044   \textcolor{keywordflow}{if} ( io\_mode & (ios::out|ios::app )) \{
00045     *p++ = \textcolor{charliteral}{'9'};
00046   \}
00047 
00048   \textcolor{comment}{// Put the end-of-string indicator}
00049   *p = \textcolor{charliteral}{'\(\backslash\)0'};
00050 
00051   \textcolor{keywordflow}{if} ( (\hyperlink{structfile}{file} = gzopen(name, char\_mode)) == NULL )
00052     \textcolor{keywordflow}{return} NULL;
00053 
00054   own\_file\_descriptor = 1;
00055 
00056   \textcolor{keywordflow}{return} \textcolor{keyword}{this};
00057 
00058 \}
00059 
00060 \hyperlink{classgzfilebuf}{gzfilebuf} *gzfilebuf::attach( \textcolor{keywordtype}{int} file\_descriptor,
00061                               \textcolor{keywordtype}{int} io\_mode ) \{
00062 
00063   \textcolor{keywordflow}{if} ( \hyperlink{classgzofstream_acb1c9c6dccaf41bc5e44c2263ea48de3}{is\_open}() )
00064     \textcolor{keywordflow}{return} NULL;
00065 
00066   \textcolor{keywordtype}{char} char\_mode[10];
00067   \textcolor{keywordtype}{char} *p = char\_mode;
00068 
00069   \textcolor{keywordflow}{if} ( io\_mode & ios::in ) \{
00070     mode = ios::in;
00071     *p++ = \textcolor{charliteral}{'r'};
00072   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( io\_mode & ios::app ) \{
00073     mode = ios::app;
00074     *p++ = \textcolor{charliteral}{'a'};
00075   \} \textcolor{keywordflow}{else} \{
00076     mode = ios::out;
00077     *p++ = \textcolor{charliteral}{'w'};
00078   \}
00079 
00080   \textcolor{keywordflow}{if} ( io\_mode & ios::binary ) \{
00081     mode |= ios::binary;
00082     *p++ = \textcolor{charliteral}{'b'};
00083   \}
00084 
00085   \textcolor{comment}{// Hard code the compression level}
00086   \textcolor{keywordflow}{if} ( io\_mode & (ios::out|ios::app )) \{
00087     *p++ = \textcolor{charliteral}{'9'};
00088   \}
00089 
00090   \textcolor{comment}{// Put the end-of-string indicator}
00091   *p = \textcolor{charliteral}{'\(\backslash\)0'};
00092 
00093   \textcolor{keywordflow}{if} ( (\hyperlink{structfile}{file} = gzdopen(file\_descriptor, char\_mode)) == NULL )
00094     \textcolor{keywordflow}{return} NULL;
00095 
00096   own\_file\_descriptor = 0;
00097 
00098   \textcolor{keywordflow}{return} \textcolor{keyword}{this};
00099 
00100 \}
00101 
00102 \hyperlink{classgzfilebuf}{gzfilebuf} *gzfilebuf::close() \{
00103 
00104   \textcolor{keywordflow}{if} ( \hyperlink{classgzofstream_acb1c9c6dccaf41bc5e44c2263ea48de3}{is\_open}() ) \{
00105 
00106     sync();
00107     gzclose( \hyperlink{structfile}{file} );
00108     \hyperlink{structfile}{file} = NULL;
00109 
00110   \}
00111 
00112   \textcolor{keywordflow}{return} \textcolor{keyword}{this};
00113 
00114 \}
00115 
00116 \textcolor{keywordtype}{int} gzfilebuf::setcompressionlevel( \textcolor{keywordtype}{int} comp\_level ) \{
00117 
00118   \textcolor{keywordflow}{return} gzsetparams(\hyperlink{structfile}{file}, comp\_level, -2);
00119 
00120 \}
00121 
00122 \textcolor{keywordtype}{int} gzfilebuf::setcompressionstrategy( \textcolor{keywordtype}{int} comp\_strategy ) \{
00123 
00124   \textcolor{keywordflow}{return} gzsetparams(\hyperlink{structfile}{file}, -2, comp\_strategy);
00125 
00126 \}
00127 
00128 
00129 streampos gzfilebuf::seekoff( streamoff off, ios::seek\_dir dir, \textcolor{keywordtype}{int} which ) \{
00130 
00131   \textcolor{keywordflow}{return} streampos(EOF);
00132 
00133 \}
00134 
00135 \textcolor{keywordtype}{int} gzfilebuf::underflow() \{
00136 
00137   \textcolor{comment}{// If the file hasn't been opened for reading, error.}
00138   \textcolor{keywordflow}{if} ( !\hyperlink{classgzofstream_acb1c9c6dccaf41bc5e44c2263ea48de3}{is\_open}() || !(mode & ios::in) )
00139     \textcolor{keywordflow}{return} EOF;
00140 
00141   \textcolor{comment}{// if a buffer doesn't exists, allocate one.}
00142   \textcolor{keywordflow}{if} ( !base() ) \{
00143 
00144     \textcolor{keywordflow}{if} ( (allocate()) == EOF )
00145       \textcolor{keywordflow}{return} EOF;
00146     setp(0,0);
00147 
00148   \} \textcolor{keywordflow}{else} \{
00149 
00150     \textcolor{keywordflow}{if} ( in\_avail() )
00151       \textcolor{keywordflow}{return} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}) *gptr();
00152 
00153     \textcolor{keywordflow}{if} ( out\_waiting() ) \{
00154       \textcolor{keywordflow}{if} ( flushbuf() == EOF )
00155         \textcolor{keywordflow}{return} EOF;
00156     \}
00157 
00158   \}
00159 
00160   \textcolor{comment}{// Attempt to fill the buffer.}
00161 
00162   \textcolor{keywordtype}{int} result = fillbuf();
00163   \textcolor{keywordflow}{if} ( result == EOF ) \{
00164     \textcolor{comment}{// disable get area}
00165     setg(0,0,0);
00166     \textcolor{keywordflow}{return} EOF;
00167   \}
00168 
00169   \textcolor{keywordflow}{return} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}) *gptr();
00170 
00171 \}
00172 
00173 \textcolor{keywordtype}{int} gzfilebuf::overflow( \textcolor{keywordtype}{int} c ) \{
00174 
00175   \textcolor{keywordflow}{if} ( !\hyperlink{classgzofstream_acb1c9c6dccaf41bc5e44c2263ea48de3}{is\_open}() || !(mode & ios::out) )
00176     \textcolor{keywordflow}{return} EOF;
00177 
00178   \textcolor{keywordflow}{if} ( !base() ) \{
00179     \textcolor{keywordflow}{if} ( allocate() == EOF )
00180       \textcolor{keywordflow}{return} EOF;
00181     setg(0,0,0);
00182   \} \textcolor{keywordflow}{else} \{
00183     \textcolor{keywordflow}{if} (in\_avail()) \{
00184         \textcolor{keywordflow}{return} EOF;
00185     \}
00186     \textcolor{keywordflow}{if} (out\_waiting()) \{
00187       \textcolor{keywordflow}{if} (flushbuf() == EOF)
00188         \textcolor{keywordflow}{return} EOF;
00189     \}
00190   \}
00191 
00192   \textcolor{keywordtype}{int} bl = blen();
00193   setp( base(), base() + bl);
00194 
00195   \textcolor{keywordflow}{if} ( c != EOF ) \{
00196 
00197     *pptr() = c;
00198     pbump(1);
00199 
00200   \}
00201 
00202   \textcolor{keywordflow}{return} 0;
00203 
00204 \}
00205 
00206 \textcolor{keywordtype}{int} gzfilebuf::sync() \{
00207 
00208   \textcolor{keywordflow}{if} ( !\hyperlink{classgzofstream_acb1c9c6dccaf41bc5e44c2263ea48de3}{is\_open}() )
00209     \textcolor{keywordflow}{return} EOF;
00210 
00211   \textcolor{keywordflow}{if} ( out\_waiting() )
00212     \textcolor{keywordflow}{return} flushbuf();
00213 
00214   \textcolor{keywordflow}{return} 0;
00215 
00216 \}
00217 
00218 \textcolor{keywordtype}{int} gzfilebuf::flushbuf() \{
00219 
00220   \textcolor{keywordtype}{int} n;
00221   \textcolor{keywordtype}{char} *q;
00222 
00223   q = pbase();
00224   n = pptr() - q;
00225 
00226   \textcolor{keywordflow}{if} ( gzwrite( \hyperlink{structfile}{file}, q, n) < n )
00227     \textcolor{keywordflow}{return} EOF;
00228 
00229   setp(0,0);
00230 
00231   \textcolor{keywordflow}{return} 0;
00232 
00233 \}
00234 
00235 \textcolor{keywordtype}{int} gzfilebuf::fillbuf() \{
00236 
00237   \textcolor{keywordtype}{int} required;
00238   \textcolor{keywordtype}{char} *p;
00239 
00240   p = base();
00241 
00242   required = blen();
00243 
00244   \textcolor{keywordtype}{int} t = gzread( \hyperlink{structfile}{file}, p, required );
00245 
00246   \textcolor{keywordflow}{if} ( t <= 0) \textcolor{keywordflow}{return} EOF;
00247 
00248   setg( base(), base(), base()+t);
00249 
00250   \textcolor{keywordflow}{return} t;
00251 
00252 \}
00253 
00254 gzfilestream\_common::gzfilestream\_common() :
00255   ios( \hyperlink{classgzfilestream__common}{gzfilestream\_common}::\hyperlink{classgzofstream_a2fef74202b114357f41cfeb28f1d2acc}{rdbuf}() )
00256 \{ \}
00257 
00258 gzfilestream\_common::~gzfilestream\_common()
00259 \{ \}
00260 
00261 \textcolor{keywordtype}{void} gzfilestream\_common::attach( \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} io\_mode ) \{
00262 
00263   \textcolor{keywordflow}{if} ( !buffer.attach( fd, io\_mode) )
00264     clear( ios::failbit | ios::badbit );
00265   \textcolor{keywordflow}{else}
00266     clear();
00267 
00268 \}
00269 
00270 \textcolor{keywordtype}{void} gzfilestream\_common::open( \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name, \textcolor{keywordtype}{int} io\_mode ) \{
00271 
00272   \textcolor{keywordflow}{if} ( !buffer.open( name, io\_mode ) )
00273     clear( ios::failbit | ios::badbit );
00274   \textcolor{keywordflow}{else}
00275     clear();
00276 
00277 \}
00278 
00279 \textcolor{keywordtype}{void} gzfilestream\_common::close() \{
00280 
00281   \textcolor{keywordflow}{if} ( !buffer.close() )
00282     clear( ios::failbit | ios::badbit );
00283 
00284 \}
00285 
00286 \hyperlink{classgzfilebuf}{gzfilebuf} *gzfilestream\_common::rdbuf()
00287 \{
00288   \textcolor{keywordflow}{return} &buffer;
00289 \}
00290 
00291 gzifstream::gzifstream() :
00292   ios( \hyperlink{classgzfilestream__common}{gzfilestream\_common}::\hyperlink{classgzofstream_a2fef74202b114357f41cfeb28f1d2acc}{rdbuf}() )
00293 \{
00294   clear( ios::badbit );
00295 \}
00296 
00297 gzifstream::gzifstream( \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name, \textcolor{keywordtype}{int} io\_mode ) :
00298   ios( \hyperlink{classgzfilestream__common}{gzfilestream\_common}::\hyperlink{classgzofstream_a2fef74202b114357f41cfeb28f1d2acc}{rdbuf}() )
00299 \{
00300   gzfilestream\_common::open( name, io\_mode );
00301 \}
00302 
00303 gzifstream::gzifstream( \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} io\_mode ) :
00304   ios( \hyperlink{classgzfilestream__common}{gzfilestream\_common}::\hyperlink{classgzofstream_a2fef74202b114357f41cfeb28f1d2acc}{rdbuf}() )
00305 \{
00306   gzfilestream\_common::attach( fd, io\_mode );
00307 \}
00308 
00309 gzifstream::~gzifstream() \{ \}
00310 
00311 gzofstream::gzofstream() :
00312   ios( \hyperlink{classgzfilestream__common}{gzfilestream\_common}::\hyperlink{classgzofstream_a2fef74202b114357f41cfeb28f1d2acc}{rdbuf}() )
00313 \{
00314   clear( ios::badbit );
00315 \}
00316 
00317 gzofstream::gzofstream( \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name, \textcolor{keywordtype}{int} io\_mode ) :
00318   ios( \hyperlink{classgzfilestream__common}{gzfilestream\_common}::\hyperlink{classgzofstream_a2fef74202b114357f41cfeb28f1d2acc}{rdbuf}() )
00319 \{
00320   gzfilestream\_common::open( name, io\_mode );
00321 \}
00322 
00323 gzofstream::gzofstream( \textcolor{keywordtype}{int} fd, \textcolor{keywordtype}{int} io\_mode ) :
00324   ios( \hyperlink{classgzfilestream__common}{gzfilestream\_common}::\hyperlink{classgzofstream_a2fef74202b114357f41cfeb28f1d2acc}{rdbuf}() )
00325 \{
00326   gzfilestream\_common::attach( fd, io\_mode );
00327 \}
00328 
00329 gzofstream::~gzofstream() \{ \}
\end{DoxyCode}
