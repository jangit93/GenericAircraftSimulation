\hypertarget{eigen_2bench_2perf__monitoring_2gemm_2lazy__gemm_8cpp_source}{}\section{eigen/bench/perf\+\_\+monitoring/gemm/lazy\+\_\+gemm.cpp}
\label{eigen_2bench_2perf__monitoring_2gemm_2lazy__gemm_8cpp_source}\index{lazy\+\_\+gemm.\+cpp@{lazy\+\_\+gemm.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#include <iostream>}
00002 \textcolor{preprocessor}{#include <fstream>}
00003 \textcolor{preprocessor}{#include <vector>}
00004 \textcolor{preprocessor}{#include <Eigen/Core>}
00005 \textcolor{preprocessor}{#include "../../BenchTimer.h"}
00006 \textcolor{keyword}{using namespace }\hyperlink{namespace_eigen}{Eigen};
00007 
00008 \textcolor{preprocessor}{#ifndef SCALAR}
00009 \textcolor{preprocessor}{#error SCALAR must be defined}
00010 \textcolor{preprocessor}{#endif}
00011 
00012 \textcolor{keyword}{typedef} SCALAR Scalar;
00013 
00014 \textcolor{keyword}{template}<\textcolor{keyword}{typename} MatA, \textcolor{keyword}{typename} MatB, \textcolor{keyword}{typename} MatC>
00015 EIGEN\_DONT\_INLINE
00016 \textcolor{keywordtype}{void} lazy\_gemm(\textcolor{keyword}{const} MatA &\hyperlink{group___core___module_class_eigen_1_1_matrix}{A}, \textcolor{keyword}{const} MatB &\hyperlink{group___core___module_class_eigen_1_1_matrix}{B}, MatC &\hyperlink{group___core___module}{C})
00017 \{
00018 \textcolor{comment}{//   escape((void*)A.data());}
00019 \textcolor{comment}{//   escape((void*)B.data());}
00020   C.noalias() += A.lazyProduct(B);
00021 \textcolor{comment}{//   escape((void*)C.data());}
00022 \}
00023 
00024 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} m, \textcolor{keywordtype}{int} n, \textcolor{keywordtype}{int} k, \textcolor{keywordtype}{int} TA>
00025 EIGEN\_DONT\_INLINE
00026 \textcolor{keywordtype}{double} bench()
00027 \{
00028   \textcolor{keyword}{typedef} \hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,m,k,TA>} MatA;
00029   \textcolor{keyword}{typedef} \hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,k,n>} MatB;
00030   \textcolor{keyword}{typedef} \hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,m,n>} MatC;
00031 
00032   MatA A(m,k);
00033   MatB B(k,n);
00034   MatC C(m,n);
00035   A.setRandom();
00036   B.setRandom();
00037   C.setZero();
00038 
00039   \hyperlink{class_eigen_1_1_bench_timer}{BenchTimer} t;
00040 
00041   \textcolor{keywordtype}{double} up = 1e7*4/\textcolor{keyword}{sizeof}(Scalar);
00042   \textcolor{keywordtype}{double} tm0 = 10, tm1 = 20;
00043 
00044   \textcolor{keywordtype}{double} flops = 2. * m * n * k;
00045   \textcolor{keywordtype}{long} rep = std::max(10., std::min(10000., up/flops) );
00046   \textcolor{keywordtype}{long} tries = std::max(tm0, std::min(tm1, up/flops) );
00047 
00048   BENCH(t, tries, rep, lazy\_gemm(A,B,C));
00049 
00050   \textcolor{keywordflow}{return} 1e-9 * rep * flops / t.\hyperlink{class_eigen_1_1_bench_timer_ae8b673b0fa356d3432c7a65c79e8af0e}{best}();
00051 \}
00052 
00053 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} m, \textcolor{keywordtype}{int} n, \textcolor{keywordtype}{int} k>
00054 \textcolor{keywordtype}{double} bench\_t(\textcolor{keywordtype}{int} t)
00055 \{
00056   \textcolor{keywordflow}{if}(t)
00057     \textcolor{keywordflow}{return} bench<m,n,k,RowMajor>();
00058   \textcolor{keywordflow}{else}
00059     \textcolor{keywordflow}{return} bench<m,n,k,0>();
00060 \}
00061 
00062 EIGEN\_DONT\_INLINE
00063 \textcolor{keywordtype}{double} bench\_mnk(\textcolor{keywordtype}{int} m, \textcolor{keywordtype}{int} n, \textcolor{keywordtype}{int} k, \textcolor{keywordtype}{int} t)
00064 \{
00065   \textcolor{keywordtype}{int} \textcolor{keywordtype}{id} = m*10000 + n*100 + k;
00066   \textcolor{keywordflow}{switch}(\textcolor{keywordtype}{id}) \{
00067     \textcolor{keywordflow}{case}  10101 : \textcolor{keywordflow}{return} bench\_t< 1, 1, 1>(t); \textcolor{keywordflow}{break};
00068     \textcolor{keywordflow}{case}  20202 : \textcolor{keywordflow}{return} bench\_t< 2, 2, 2>(t); \textcolor{keywordflow}{break};
00069     \textcolor{keywordflow}{case}  30303 : \textcolor{keywordflow}{return} bench\_t< 3, 3, 3>(t); \textcolor{keywordflow}{break};
00070     \textcolor{keywordflow}{case}  40404 : \textcolor{keywordflow}{return} bench\_t< 4, 4, 4>(t); \textcolor{keywordflow}{break};
00071     \textcolor{keywordflow}{case}  50505 : \textcolor{keywordflow}{return} bench\_t< 5, 5, 5>(t); \textcolor{keywordflow}{break};
00072     \textcolor{keywordflow}{case}  60606 : \textcolor{keywordflow}{return} bench\_t< 6, 6, 6>(t); \textcolor{keywordflow}{break};
00073     \textcolor{keywordflow}{case}  70707 : \textcolor{keywordflow}{return} bench\_t< 7, 7, 7>(t); \textcolor{keywordflow}{break};
00074     \textcolor{keywordflow}{case}  80808 : \textcolor{keywordflow}{return} bench\_t< 8, 8, 8>(t); \textcolor{keywordflow}{break};
00075     \textcolor{keywordflow}{case}  90909 : \textcolor{keywordflow}{return} bench\_t< 9, 9, 9>(t); \textcolor{keywordflow}{break};
00076     \textcolor{keywordflow}{case} 101010 : \textcolor{keywordflow}{return} bench\_t<10,10,10>(t); \textcolor{keywordflow}{break};
00077     \textcolor{keywordflow}{case} 111111 : \textcolor{keywordflow}{return} bench\_t<11,11,11>(t); \textcolor{keywordflow}{break};
00078     \textcolor{keywordflow}{case} 121212 : \textcolor{keywordflow}{return} bench\_t<12,12,12>(t); \textcolor{keywordflow}{break};
00079   \}
00080   \textcolor{keywordflow}{return} 0;
00081 \}
00082 
00083 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} **argv)
00084 \{
00085   std::vector<double> results;
00086   
00087   std::ifstream settings(\textcolor{stringliteral}{"lazy\_gemm\_settings.txt"});
00088   \textcolor{keywordtype}{long} m, n, k, t;
00089   \textcolor{keywordflow}{while}(settings >> m >> n >> k >> t)
00090   \{
00091     \textcolor{comment}{//std::cerr << "  Testing " << m << " " << n << " " << k << std::endl;}
00092     results.push\_back( bench\_mnk(m, n, k, t) );
00093   \}
00094   
00095   std::cout << RowVectorXd::Map(results.data(), results.size());
00096   
00097   \textcolor{keywordflow}{return} 0;
00098 \}
\end{DoxyCode}
