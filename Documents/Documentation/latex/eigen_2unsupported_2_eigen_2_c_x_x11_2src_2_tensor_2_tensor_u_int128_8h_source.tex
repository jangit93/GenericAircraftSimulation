\hypertarget{eigen_2unsupported_2_eigen_2_c_x_x11_2src_2_tensor_2_tensor_u_int128_8h_source}{}\section{eigen/unsupported/\+Eigen/\+C\+X\+X11/src/\+Tensor/\+Tensor\+U\+Int128.h}
\label{eigen_2unsupported_2_eigen_2_c_x_x11_2src_2_tensor_2_tensor_u_int128_8h_source}\index{Tensor\+U\+Int128.\+h@{Tensor\+U\+Int128.\+h}}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of Eigen, a lightweight C++ template library}
00002 \textcolor{comment}{// for linear algebra.}
00003 \textcolor{comment}{//}
00004 \textcolor{comment}{// Copyright (C) 2015 Benoit Steiner <benoit.steiner.goog@gmail.com>}
00005 \textcolor{comment}{//}
00006 \textcolor{comment}{// This Source Code Form is subject to the terms of the Mozilla}
00007 \textcolor{comment}{// Public License v. 2.0. If a copy of the MPL was not distributed}
00008 \textcolor{comment}{// with this file, You can obtain one at http://mozilla.org/MPL/2.0/.}
00009 
00010 \textcolor{preprocessor}{#ifndef EIGEN\_CXX11\_TENSOR\_TENSOR\_UINT128\_H}
00011 \textcolor{preprocessor}{#define EIGEN\_CXX11\_TENSOR\_TENSOR\_UINT128\_H}
00012 
00013 \textcolor{keyword}{namespace }\hyperlink{namespace_eigen}{Eigen} \{
00014 \textcolor{keyword}{namespace }\hyperlink{namespaceinternal}{internal} \{
00015 
00016 
00017 \textcolor{keyword}{template} <u\textcolor{keywordtype}{int}64\_t n>
\Hypertarget{eigen_2unsupported_2_eigen_2_c_x_x11_2src_2_tensor_2_tensor_u_int128_8h_source_l00018}\hyperlink{struct_eigen_1_1internal_1_1static__val}{00018} \textcolor{keyword}{struct }\hyperlink{struct_eigen_1_1internal_1_1static__val}{static\_val} \{
00019   \textcolor{keyword}{static} \textcolor{keyword}{const} uint64\_t value = n;
00020   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE \textcolor{keyword}{operator} uint64\_t()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} n; \}
00021 
00022   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE \hyperlink{struct_eigen_1_1internal_1_1static__val}{static\_val}() \{ \}
00023 
00024   \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>
00025   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE \hyperlink{struct_eigen_1_1internal_1_1static__val}{static\_val}(\textcolor{keyword}{const} \hyperlink{group___sparse_core___module}{T}& v) \{
00026     eigen\_assert(v == n);
00027   \}
00028 \};
00029 
00030 
00031 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HIGH = u\textcolor{keywordtype}{int}64\_t, \textcolor{keyword}{typename} LOW = u\textcolor{keywordtype}{int}64\_t>
\Hypertarget{eigen_2unsupported_2_eigen_2_c_x_x11_2src_2_tensor_2_tensor_u_int128_8h_source_l00032}\hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{00032} \textcolor{keyword}{struct }\hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128}
00033 \{
00034   HIGH high;
00035   LOW low;
00036 
00037   \textcolor{keyword}{template}<\textcolor{keyword}{typename} OTHER\_HIGH, \textcolor{keyword}{typename} OTHER\_LOW>
00038   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00039   \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128}(\textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<OTHER\_HIGH, OTHER\_LOW>}
      & other) : high(other.high), low(other.low) \{
00040     EIGEN\_STATIC\_ASSERT(\textcolor{keyword}{sizeof}(OTHER\_HIGH) <= \textcolor{keyword}{sizeof}(HIGH), YOU\_MADE\_A\_PROGRAMMING\_MISTAKE);
00041     EIGEN\_STATIC\_ASSERT(\textcolor{keyword}{sizeof}(OTHER\_LOW) <= \textcolor{keyword}{sizeof}(LOW), YOU\_MADE\_A\_PROGRAMMING\_MISTAKE);
00042   \}
00043 
00044   \textcolor{keyword}{template}<\textcolor{keyword}{typename} OTHER\_HIGH, \textcolor{keyword}{typename} OTHER\_LOW>
00045   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00046   TensorUInt128& operator = (\textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<OTHER\_HIGH, OTHER\_LOW>}
      & other) \{
00047     EIGEN\_STATIC\_ASSERT(\textcolor{keyword}{sizeof}(OTHER\_HIGH) <= \textcolor{keyword}{sizeof}(HIGH), YOU\_MADE\_A\_PROGRAMMING\_MISTAKE);
00048     EIGEN\_STATIC\_ASSERT(\textcolor{keyword}{sizeof}(OTHER\_LOW) <= \textcolor{keyword}{sizeof}(LOW), YOU\_MADE\_A\_PROGRAMMING\_MISTAKE);
00049     high = other.high;
00050     low = other.low;
00051     \textcolor{keywordflow}{return} *\textcolor{keyword}{this};
00052   \}
00053 
00054   \textcolor{keyword}{template}<\textcolor{keyword}{typename} T>
00055   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00056   \textcolor{keyword}{explicit} TensorUInt128(\textcolor{keyword}{const} \hyperlink{group___sparse_core___module}{T}& x) : high(0), low(x) \{
00057     eigen\_assert((\textcolor{keyword}{static\_cast<}typename 
      \hyperlink{class_eigen_1_1internal_1_1_tensor_lazy_evaluator_writable}{conditional<sizeof(T) == 8, uint64\_t, uint32\_t>::type}\textcolor{keyword}{>}
      (x) <= \hyperlink{group___core___module_struct_eigen_1_1_num_traits}{NumTraits<uint64\_t>::highest}()));
00058     eigen\_assert(x >= 0);
00059   \}
00060 
00061   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00062   TensorUInt128(HIGH y, LOW x) : high(y), low(x) \{ \}
00063 
00064   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE \textcolor{keyword}{operator} LOW()\textcolor{keyword}{ const }\{
00065     \textcolor{keywordflow}{return} low;
00066   \}
00067   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE LOW lower()\textcolor{keyword}{ const }\{
00068     \textcolor{keywordflow}{return} low;
00069   \}
00070   EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE HIGH upper()\textcolor{keyword}{ const }\{
00071     \textcolor{keywordflow}{return} high;
00072   \}
00073 \};
00074 
00075 
00076 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HL, \textcolor{keyword}{typename} LL, \textcolor{keyword}{typename} HR, \textcolor{keyword}{typename} LR>
00077 EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00078 \textcolor{keywordtype}{bool} operator == (\textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HL, LL>}& lhs, \textcolor{keyword}{const} 
      \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HR, LR>}& rhs)
00079 \{
00080   \textcolor{keywordflow}{return} (lhs.high == rhs.high) & (lhs.low == rhs.low);
00081 \}
00082 
00083 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HL, \textcolor{keyword}{typename} LL, \textcolor{keyword}{typename} HR, \textcolor{keyword}{typename} LR>
00084 EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00085 \textcolor{keywordtype}{bool} operator != (\textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HL, LL>}& lhs, \textcolor{keyword}{const} 
      \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HR, LR>}& rhs)
00086 \{
00087   \textcolor{keywordflow}{return} (lhs.high != rhs.high) | (lhs.low != rhs.low);
00088 \}
00089 
00090 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HL, \textcolor{keyword}{typename} LL, \textcolor{keyword}{typename} HR, \textcolor{keyword}{typename} LR>
00091 EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00092 \textcolor{keywordtype}{bool} operator >= (\textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HL, LL>}& lhs, \textcolor{keyword}{const} 
      \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HR, LR>}& rhs)
00093 \{
00094   \textcolor{keywordflow}{if} (lhs.high != rhs.high) \{
00095     \textcolor{keywordflow}{return} lhs.high > rhs.high;
00096   \}
00097   \textcolor{keywordflow}{return} lhs.low >= rhs.low;
00098 \}
00099 
00100 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HL, \textcolor{keyword}{typename} LL, \textcolor{keyword}{typename} HR, \textcolor{keyword}{typename} LR>
00101 EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00102 \textcolor{keywordtype}{bool} operator < (const TensorUInt128<HL, LL>& lhs, \textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HR, LR>}& rhs)
00103 \{
00104   \textcolor{keywordflow}{if} (lhs.high != rhs.high) \{
00105     \textcolor{keywordflow}{return} lhs.high < rhs.high;
00106   \}
00107   \textcolor{keywordflow}{return} lhs.low < rhs.low;
00108 \}
00109 
00110 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HL, \textcolor{keyword}{typename} LL, \textcolor{keyword}{typename} HR, \textcolor{keyword}{typename} LR>
00111 EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00112 \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} operator + (\textcolor{keyword}{const} 
      \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HL, LL>}& lhs, \textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HR, LR>}& rhs)
00113 \{
00114   \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} result(lhs.high + rhs.high, lhs.low + 
      rhs.low);
00115   \textcolor{keywordflow}{if} (result.low < rhs.low) \{
00116     result.high += 1;
00117   \}
00118   \textcolor{keywordflow}{return} result;
00119 \}
00120 
00121 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HL, \textcolor{keyword}{typename} LL, \textcolor{keyword}{typename} HR, \textcolor{keyword}{typename} LR>
00122 EIGEN\_DEVICE\_FUNC EIGEN\_ALWAYS\_INLINE
00123 \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} operator - (\textcolor{keyword}{const} 
      \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HL, LL>}& lhs, \textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HR, LR>}& rhs)
00124 \{
00125   \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} result(lhs.high - rhs.high, lhs.low - 
      rhs.low);
00126   \textcolor{keywordflow}{if} (result.low > lhs.low) \{
00127     result.high -= 1;
00128   \}
00129   \textcolor{keywordflow}{return} result;
00130 \}
00131 
00132 
00133 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HL, \textcolor{keyword}{typename} LL, \textcolor{keyword}{typename} HR, \textcolor{keyword}{typename} LR>
00134 \textcolor{keyword}{static} EIGEN\_DEVICE\_FUNC EIGEN\_STRONG\_INLINE
00135 \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} operator * (\textcolor{keyword}{const} 
      \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HL, LL>}& lhs, \textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HR, LR>}& rhs)
00136 \{
00137   \textcolor{comment}{// Split each 128-bit integer into 4 32-bit integers, and then do the}
00138   \textcolor{comment}{// multiplications by hand as follow:}
00139   \textcolor{comment}{//   lhs      a  b  c  d}
00140   \textcolor{comment}{//   rhs      e  f  g  h}
00141   \textcolor{comment}{//           -----------}
00142   \textcolor{comment}{//           ah bh ch dh}
00143   \textcolor{comment}{//           bg cg dg}
00144   \textcolor{comment}{//           cf df}
00145   \textcolor{comment}{//           de}
00146   \textcolor{comment}{// The result is stored in 2 64bit integers, high and low.}
00147 
00148   \textcolor{keyword}{const} uint64\_t LOW = 0x00000000FFFFFFFFLL;
00149   \textcolor{keyword}{const} uint64\_t HIGH = 0xFFFFFFFF00000000LL;
00150 
00151   uint64\_t d = lhs.low & LOW;
00152   uint64\_t c = (lhs.low & HIGH) >> 32LL;
00153   uint64\_t b = lhs.high & LOW;
00154   uint64\_t a = (lhs.high & HIGH) >> 32LL;
00155 
00156   uint64\_t h = rhs.low & LOW;
00157   uint64\_t g = (rhs.low & HIGH) >> 32LL;
00158   uint64\_t f = rhs.high & LOW;
00159   uint64\_t e = (rhs.high & HIGH) >> 32LL;
00160 
00161   \textcolor{comment}{// Compute the low 32 bits of low}
00162   uint64\_t acc = d * h;
00163   uint64\_t low = acc & LOW;
00164   \textcolor{comment}{//  Compute the high 32 bits of low. Add a carry every time we wrap around}
00165   acc >>= 32LL;
00166   uint64\_t carry = 0;
00167   uint64\_t acc2 = acc + c * h;
00168   \textcolor{keywordflow}{if} (acc2 < acc) \{
00169     carry++;
00170   \}
00171   acc = acc2 + d * g;
00172   \textcolor{keywordflow}{if} (acc < acc2) \{
00173     carry++;
00174   \}
00175   low |= (acc << 32LL);
00176 
00177   \textcolor{comment}{// Carry forward the high bits of acc to initiate the computation of the}
00178   \textcolor{comment}{// low 32 bits of high}
00179   acc2 = (acc >> 32LL) | (carry << 32LL);
00180   carry = 0;
00181 
00182   acc = acc2 + b * h;
00183   \textcolor{keywordflow}{if} (acc < acc2) \{
00184     carry++;
00185   \}
00186   acc2 = acc + c * g;
00187   \textcolor{keywordflow}{if} (acc2 < acc) \{
00188     carry++;
00189   \}
00190   acc = acc2 + d * f;
00191   \textcolor{keywordflow}{if} (acc < acc2) \{
00192     carry++;
00193   \}
00194   uint64\_t high = acc & LOW;
00195 
00196   \textcolor{comment}{// Start to compute the high 32 bits of high.}
00197   acc2 = (acc >> 32LL) | (carry << 32LL);
00198 
00199   acc = acc2 + a * h;
00200   acc2 = acc + b * g;
00201   acc = acc2 + c * f;
00202   acc2 = acc + d * e;
00203   high |= (acc2 << 32LL);
00204 
00205   \textcolor{keywordflow}{return} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>}(high, low);
00206 \}
00207 
00208 \textcolor{keyword}{template} <\textcolor{keyword}{typename} HL, \textcolor{keyword}{typename} LL, \textcolor{keyword}{typename} HR, \textcolor{keyword}{typename} LR>
00209 \textcolor{keyword}{static} EIGEN\_DEVICE\_FUNC EIGEN\_STRONG\_INLINE
00210 \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} operator / (\textcolor{keyword}{const} 
      \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HL, LL>}& lhs, \textcolor{keyword}{const} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<HR, LR>}& rhs)
00211 \{
00212   \textcolor{keywordflow}{if} (rhs == \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128}<\hyperlink{struct_eigen_1_1internal_1_1static__val}{static\_val<0>}, 
      \hyperlink{struct_eigen_1_1internal_1_1static__val}{static\_val<1>} >(1)) \{
00213     \textcolor{keywordflow}{return} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>}(lhs.high, lhs.low);
00214   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (lhs < rhs) \{
00215     \textcolor{keywordflow}{return} \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>}(0);
00216   \} \textcolor{keywordflow}{else} \{
00217     \textcolor{comment}{// calculate the biggest power of 2 times rhs that's less than or equal to lhs}
00218     \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} power2(1);
00219     \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} d(rhs);
00220     \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} tmp(lhs - d);
00221     \textcolor{keywordflow}{while} (lhs >= d) \{
00222       tmp = tmp - d;
00223       d = d + d;
00224       power2 = power2 + power2;
00225     \}
00226 
00227     tmp = \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>}(lhs.high, lhs.low);
00228     \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>} result(0);
00229     \textcolor{keywordflow}{while} (power2 != \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128}<\hyperlink{struct_eigen_1_1internal_1_1static__val}{static\_val<0>}, 
      \hyperlink{struct_eigen_1_1internal_1_1static__val}{static\_val<0>} >(0)) \{
00230       \textcolor{keywordflow}{if} (tmp >= d) \{
00231         tmp = tmp - d;
00232         result = result + power2;
00233       \}
00234       \textcolor{comment}{// Shift right}
00235       power2 = \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>}(power2.high >> 1, (power2
      .low >> 1) | (power2.high << 63));
00236       d = \hyperlink{struct_eigen_1_1internal_1_1_tensor_u_int128}{TensorUInt128<uint64\_t, uint64\_t>}(d.high >> 1, (d.low >> 1) | (d
      .high << 63));
00237     \}
00238 
00239     \textcolor{keywordflow}{return} result;
00240   \}
00241 \}
00242 
00243 
00244 \}  \textcolor{comment}{// namespace internal}
00245 \}  \textcolor{comment}{// namespace Eigen}
00246 
00247 
00248 \textcolor{preprocessor}{#endif  // EIGEN\_CXX11\_TENSOR\_TENSOR\_UINT128\_H}
\end{DoxyCode}
