\hypertarget{matio_2visual__studio_2test_2eigen_2unsupported_2test_2cxx11__non__blocking__thread__pool_8cpp_source}{}\section{matio/visual\+\_\+studio/test/eigen/unsupported/test/cxx11\+\_\+non\+\_\+blocking\+\_\+thread\+\_\+pool.cpp}
\label{matio_2visual__studio_2test_2eigen_2unsupported_2test_2cxx11__non__blocking__thread__pool_8cpp_source}\index{cxx11\+\_\+non\+\_\+blocking\+\_\+thread\+\_\+pool.\+cpp@{cxx11\+\_\+non\+\_\+blocking\+\_\+thread\+\_\+pool.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of Eigen, a lightweight C++ template library}
00002 \textcolor{comment}{// for linear algebra.}
00003 \textcolor{comment}{//}
00004 \textcolor{comment}{// Copyright (C) 2016 Dmitry Vyukov <dvyukov@google.com>}
00005 \textcolor{comment}{// Copyright (C) 2016 Benoit Steiner <benoit.steiner.goog@gmail.com>}
00006 \textcolor{comment}{//}
00007 \textcolor{comment}{// This Source Code Form is subject to the terms of the Mozilla}
00008 \textcolor{comment}{// Public License v. 2.0. If a copy of the MPL was not distributed}
00009 \textcolor{comment}{// with this file, You can obtain one at http://mozilla.org/MPL/2.0/.}
00010 
00011 \textcolor{preprocessor}{#define EIGEN\_USE\_THREADS}
00012 \textcolor{preprocessor}{#include "main.h"}
00013 \textcolor{preprocessor}{#include "Eigen/CXX11/ThreadPool"}
00014 
00015 \textcolor{keyword}{static} \textcolor{keywordtype}{void} test\_create\_destroy\_empty\_pool()
00016 \{
00017   \textcolor{comment}{// Just create and destroy the pool. This will wind up and tear down worker}
00018   \textcolor{comment}{// threads. Ensure there are no issues in that logic.}
00019   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 16; ++i) \{
00020     NonBlockingThreadPool tp(i);
00021   \}
00022 \}
00023 
00024 
00025 \textcolor{keyword}{static} \textcolor{keywordtype}{void} test\_parallelism()
00026 \{
00027   \textcolor{comment}{// Test we never-ever fail to match available tasks with idle threads.}
00028   \textcolor{keyword}{const} \textcolor{keywordtype}{int} kThreads = 16;  \textcolor{comment}{// code below expects that this is a multiple of 4}
00029   NonBlockingThreadPool tp(kThreads);
00030   VERIFY\_IS\_EQUAL(tp.NumThreads(), kThreads);
00031   VERIFY\_IS\_EQUAL(tp.CurrentThreadId(), -1);
00032   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} iter = 0; iter < 100; ++iter) \{
00033     std::atomic<int> running(0);
00034     std::atomic<int> done(0);
00035     std::atomic<int> phase(0);
00036     \textcolor{comment}{// Schedule kThreads tasks and ensure that they all are running.}
00037     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < kThreads; ++i) \{
00038       tp.Schedule([&]() \{
00039         \textcolor{keyword}{const} \textcolor{keywordtype}{int} thread\_id = tp.CurrentThreadId();
00040         VERIFY\_GE(thread\_id, 0);
00041         VERIFY\_LE(thread\_id, kThreads - 1);
00042         running++;
00043         \textcolor{keywordflow}{while} (phase < 1) \{
00044         \}
00045         done++;
00046       \});
00047     \}
00048     \textcolor{keywordflow}{while} (running != kThreads) \{
00049     \}
00050     running = 0;
00051     phase = 1;
00052     \textcolor{comment}{// Now, while the previous tasks exit, schedule another kThreads tasks and}
00053     \textcolor{comment}{// ensure that they are running.}
00054     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < kThreads; ++i) \{
00055       tp.Schedule([&, i]() \{
00056         running++;
00057         \textcolor{keywordflow}{while} (phase < 2) \{
00058         \}
00059         \textcolor{comment}{// When all tasks are running, half of tasks exit, quarter of tasks}
00060         \textcolor{comment}{// continue running and quarter of tasks schedule another 2 tasks each.}
00061         \textcolor{comment}{// Concurrently main thread schedules another quarter of tasks.}
00062         \textcolor{comment}{// This gives us another kThreads tasks and we ensure that they all}
00063         \textcolor{comment}{// are running.}
00064         \textcolor{keywordflow}{if} (i < kThreads / 2) \{
00065         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (i < 3 * kThreads / 4) \{
00066           running++;
00067           \textcolor{keywordflow}{while} (phase < 3) \{
00068           \}
00069           done++;
00070         \} \textcolor{keywordflow}{else} \{
00071           \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j < 2; ++j) \{
00072             tp.Schedule([&]() \{
00073               running++;
00074               \textcolor{keywordflow}{while} (phase < 3) \{
00075               \}
00076               done++;
00077             \});
00078           \}
00079         \}
00080         done++;
00081       \});
00082     \}
00083     \textcolor{keywordflow}{while} (running != kThreads) \{
00084     \}
00085     running = 0;
00086     phase = 2;
00087     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < kThreads / 4; ++i) \{
00088       tp.Schedule([&]() \{
00089         running++;
00090         \textcolor{keywordflow}{while} (phase < 3) \{
00091         \}
00092         done++;
00093       \});
00094     \}
00095     \textcolor{keywordflow}{while} (running != kThreads) \{
00096     \}
00097     phase = 3;
00098     \textcolor{keywordflow}{while} (done != 3 * kThreads) \{
00099     \}
00100   \}
00101 \}
00102 
00103 \textcolor{keywordtype}{void} test\_cxx11\_non\_blocking\_thread\_pool()
00104 \{
00105   CALL\_SUBTEST(test\_create\_destroy\_empty\_pool());
00106   CALL\_SUBTEST(test\_parallelism());
00107 \}
\end{DoxyCode}
