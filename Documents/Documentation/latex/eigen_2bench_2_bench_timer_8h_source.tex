\hypertarget{eigen_2bench_2_bench_timer_8h_source}{}\section{eigen/bench/\+Bench\+Timer.h}
\label{eigen_2bench_2_bench_timer_8h_source}\index{Bench\+Timer.\+h@{Bench\+Timer.\+h}}

\begin{DoxyCode}
00001 \textcolor{comment}{// This file is part of Eigen, a lightweight C++ template library}
00002 \textcolor{comment}{// for linear algebra.}
00003 \textcolor{comment}{//}
00004 \textcolor{comment}{// Copyright (C) 2008-2010 Gael Guennebaud <gael.guennebaud@inria.fr>}
00005 \textcolor{comment}{// Copyright (C) 2009 Benoit Jacob <jacob.benoit.1@gmail.com>}
00006 \textcolor{comment}{//}
00007 \textcolor{comment}{// This Source Code Form is subject to the terms of the Mozilla}
00008 \textcolor{comment}{// Public License v. 2.0. If a copy of the MPL was not distributed}
00009 \textcolor{comment}{// with this file, You can obtain one at http://mozilla.org/MPL/2.0/.}
00010 
00011 \textcolor{preprocessor}{#ifndef EIGEN\_BENCH\_TIMERR\_H}
00012 \textcolor{preprocessor}{#define EIGEN\_BENCH\_TIMERR\_H}
00013 
00014 \textcolor{preprocessor}{#if defined(\_WIN32) || defined(\_\_CYGWIN\_\_)}
00015 \textcolor{preprocessor}{# ifndef NOMINMAX}
00016 \textcolor{preprocessor}{#   define NOMINMAX}
00017 \textcolor{preprocessor}{#   define EIGEN\_BT\_UNDEF\_NOMINMAX}
00018 \textcolor{preprocessor}{# endif}
00019 \textcolor{preprocessor}{# ifndef WIN32\_LEAN\_AND\_MEAN}
00020 \textcolor{preprocessor}{#   define WIN32\_LEAN\_AND\_MEAN}
00021 \textcolor{preprocessor}{#   define EIGEN\_BT\_UNDEF\_WIN32\_LEAN\_AND\_MEAN}
00022 \textcolor{preprocessor}{# endif}
00023 \textcolor{preprocessor}{# include <windows.h>}
00024 \textcolor{preprocessor}{#elif defined(\_\_APPLE\_\_)}
00025 \textcolor{preprocessor}{#include <mach/mach\_time.h>}
00026 \textcolor{preprocessor}{#else}
00027 \textcolor{preprocessor}{# include <unistd.h>}
00028 \textcolor{preprocessor}{#endif}
00029 
00030 \textcolor{keyword}{static} \textcolor{keywordtype}{void} escape(\textcolor{keywordtype}{void} *p) \{
00031   \textcolor{keyword}{asm} \textcolor{keyword}{volatile}(\textcolor{stringliteral}{""} : : \textcolor{stringliteral}{"g"}(p) : \textcolor{stringliteral}{"memory"});
00032 \}
00033 
00034 \textcolor{keyword}{static} \textcolor{keywordtype}{void} clobber() \{
00035   \textcolor{keyword}{asm} \textcolor{keyword}{volatile}(\textcolor{stringliteral}{""} : : : \textcolor{stringliteral}{"memory"});
00036 \}
00037 
00038 \textcolor{preprocessor}{#include <Eigen/Core>}
00039 
00040 \textcolor{keyword}{namespace }\hyperlink{namespace_eigen}{Eigen}
00041 \{
00042 
00043 \textcolor{keyword}{enum} \{
00044   CPU\_TIMER = 0,
00045   REAL\_TIMER = 1
00046 \};
00047 
\Hypertarget{eigen_2bench_2_bench_timer_8h_source_l00055}\hyperlink{class_eigen_1_1_bench_timer}{00055} \textcolor{keyword}{class }\hyperlink{class_eigen_1_1_bench_timer}{BenchTimer}
00056 \{
00057 \textcolor{keyword}{public}:
00058 
00059   \hyperlink{class_eigen_1_1_bench_timer}{BenchTimer}()
00060   \{
00061 \textcolor{preprocessor}{#if defined(\_WIN32) || defined(\_\_CYGWIN\_\_)}
00062     LARGE\_INTEGER freq;
00063     QueryPerformanceFrequency(&freq);
00064     m\_frequency = (double)freq.QuadPart;
00065 #endif
00066     reset();
00067   \}
00068 
00069   ~\hyperlink{class_eigen_1_1_bench_timer}{BenchTimer}() \{\}
00070 
00071   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} reset()
00072   \{
00073     m\_bests.fill(1e9);
00074     m\_worsts.fill(0);
00075     m\_totals.setZero();
00076   \}
00077   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} start()
00078   \{
00079     m\_starts[CPU\_TIMER]  = getCpuTime();
00080     m\_starts[REAL\_TIMER] = getRealTime();
00081   \}
00082   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} stop()
00083   \{
00084     m\_times[CPU\_TIMER] = getCpuTime() - m\_starts[CPU\_TIMER];
00085     m\_times[REAL\_TIMER] = getRealTime() - m\_starts[REAL\_TIMER];
00086 \textcolor{preprocessor}{    #if EIGEN\_VERSION\_AT\_LEAST(2,90,0)}
00087     m\_bests = m\_bests.cwiseMin(m\_times);
00088     m\_worsts = m\_worsts.cwiseMax(m\_times);
00089 \textcolor{preprocessor}{    #else}
00090     m\_bests(0) = std::min(m\_bests(0),m\_times(0));
00091     m\_bests(1) = std::min(m\_bests(1),m\_times(1));
00092     m\_worsts(0) = std::max(m\_worsts(0),m\_times(0));
00093     m\_worsts(1) = std::max(m\_worsts(1),m\_times(1));
00094 \textcolor{preprocessor}{    #endif}
00095     m\_totals += m\_times;
00096   \}
00097 
\Hypertarget{eigen_2bench_2_bench_timer_8h_source_l00100}\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{00100}   \textcolor{keyword}{inline} \textcolor{keywordtype}{double} \hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}(\textcolor{keywordtype}{int} TIMER = CPU\_TIMER)\textcolor{keyword}{ const}
00101 \textcolor{keyword}{  }\{
00102     \textcolor{keywordflow}{return} m\_times[TIMER];
00103   \}
00104 
\Hypertarget{eigen_2bench_2_bench_timer_8h_source_l00107}\hyperlink{class_eigen_1_1_bench_timer_ae8b673b0fa356d3432c7a65c79e8af0e}{00107}   \textcolor{keyword}{inline} \textcolor{keywordtype}{double} \hyperlink{class_eigen_1_1_bench_timer_ae8b673b0fa356d3432c7a65c79e8af0e}{best}(\textcolor{keywordtype}{int} TIMER = CPU\_TIMER)\textcolor{keyword}{ const}
00108 \textcolor{keyword}{  }\{
00109     \textcolor{keywordflow}{return} m\_bests[TIMER];
00110   \}
00111 
\Hypertarget{eigen_2bench_2_bench_timer_8h_source_l00114}\hyperlink{class_eigen_1_1_bench_timer_ab912bf8bcae22898c85d907f0810173e}{00114}   \textcolor{keyword}{inline} \textcolor{keywordtype}{double} \hyperlink{class_eigen_1_1_bench_timer_ab912bf8bcae22898c85d907f0810173e}{worst}(\textcolor{keywordtype}{int} TIMER = CPU\_TIMER)\textcolor{keyword}{ const}
00115 \textcolor{keyword}{  }\{
00116     \textcolor{keywordflow}{return} m\_worsts[TIMER];
00117   \}
00118 
\Hypertarget{eigen_2bench_2_bench_timer_8h_source_l00121}\hyperlink{class_eigen_1_1_bench_timer_af341aa613dba2d4a3d167093197e4e7a}{00121}   \textcolor{keyword}{inline} \textcolor{keywordtype}{double} \hyperlink{class_eigen_1_1_bench_timer_af341aa613dba2d4a3d167093197e4e7a}{total}(\textcolor{keywordtype}{int} TIMER = CPU\_TIMER)\textcolor{keyword}{ const}
00122 \textcolor{keyword}{  }\{
00123     \textcolor{keywordflow}{return} m\_totals[TIMER];
00124   \}
00125 
00126   \textcolor{keyword}{inline} \textcolor{keywordtype}{double} getCpuTime()\textcolor{keyword}{ const}
00127 \textcolor{keyword}{  }\{
00128 \textcolor{preprocessor}{#ifdef \_WIN32}
00129     LARGE\_INTEGER query\_ticks;
00130     QueryPerformanceCounter(&query\_ticks);
00131     \textcolor{keywordflow}{return} query\_ticks.QuadPart/m\_frequency;
00132 \textcolor{preprocessor}{#elif \_\_APPLE\_\_}
00133     \textcolor{keywordflow}{return} double(mach\_absolute\_time())*1e-9;
00134 \textcolor{preprocessor}{#else}
00135     timespec ts;
00136     clock\_gettime(CLOCK\_PROCESS\_CPUTIME\_ID, &ts);
00137     \textcolor{keywordflow}{return} double(ts.tv\_sec) + 1e-9 * double(ts.tv\_nsec);
00138 \textcolor{preprocessor}{#endif}
00139   \}
00140 
00141   \textcolor{keyword}{inline} \textcolor{keywordtype}{double} getRealTime()\textcolor{keyword}{ const}
00142 \textcolor{keyword}{  }\{
00143 \textcolor{preprocessor}{#ifdef \_WIN32}
00144     SYSTEMTIME st;
00145     GetSystemTime(&st);
00146     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{double})st.wSecond + 1.e-3 * (double)st.wMilliseconds;
00147 #elif \_\_APPLE\_\_
00148     \textcolor{keywordflow}{return} \textcolor{keywordtype}{double}(mach\_absolute\_time())*1e-9;
00149 \textcolor{preprocessor}{#else}
00150     timespec ts;
00151     clock\_gettime(CLOCK\_REALTIME, &ts);
00152     \textcolor{keywordflow}{return} double(ts.tv\_sec) + 1e-9 * double(ts.tv\_nsec);
00153 \textcolor{preprocessor}{#endif}
00154   \}
00155 
00156 \textcolor{keyword}{protected}:
00157 \textcolor{preprocessor}{#if defined(\_WIN32) || defined(\_\_CYGWIN\_\_)}
00158   \textcolor{keywordtype}{double} m\_frequency;
00159 \textcolor{preprocessor}{#endif}
00160   Vector2d m\_starts;
00161   Vector2d m\_times;
00162   Vector2d m\_bests;
00163   Vector2d m\_worsts;
00164   Vector2d m\_totals;
00165 
00166 \textcolor{keyword}{public}:
00167   EIGEN\_MAKE\_ALIGNED\_OPERATOR\_NEW
00168 \};
00169 
00170 \textcolor{preprocessor}{#define BENCH(TIMER,TRIES,REP,CODE) \{ \(\backslash\)}
00171 \textcolor{preprocessor}{    TIMER.reset(); \(\backslash\)}
00172 \textcolor{preprocessor}{    for(int uglyvarname1=0; uglyvarname1<TRIES; ++uglyvarname1)\{ \(\backslash\)}
00173 \textcolor{preprocessor}{      TIMER.start(); \(\backslash\)}
00174 \textcolor{preprocessor}{      for(int uglyvarname2=0; uglyvarname2<REP; ++uglyvarname2)\{ \(\backslash\)}
00175 \textcolor{preprocessor}{        CODE; \(\backslash\)}
00176 \textcolor{preprocessor}{      \} \(\backslash\)}
00177 \textcolor{preprocessor}{      TIMER.stop(); \(\backslash\)}
00178 \textcolor{preprocessor}{      clobber(); \(\backslash\)}
00179 \textcolor{preprocessor}{    \} \(\backslash\)}
00180 \textcolor{preprocessor}{  \}}
00181 
00182 \}
00183 
00184 \textcolor{comment}{// clean #defined tokens}
00185 \textcolor{preprocessor}{#ifdef EIGEN\_BT\_UNDEF\_NOMINMAX}
00186 \textcolor{preprocessor}{# undef EIGEN\_BT\_UNDEF\_NOMINMAX}
00187 \textcolor{preprocessor}{# undef NOMINMAX}
00188 \textcolor{preprocessor}{#endif}
00189 
00190 \textcolor{preprocessor}{#ifdef EIGEN\_BT\_UNDEF\_WIN32\_LEAN\_AND\_MEAN}
00191 \textcolor{preprocessor}{# undef EIGEN\_BT\_UNDEF\_WIN32\_LEAN\_AND\_MEAN}
00192 \textcolor{preprocessor}{# undef WIN32\_LEAN\_AND\_MEAN}
00193 \textcolor{preprocessor}{#endif}
00194 
00195 \textcolor{preprocessor}{#endif // EIGEN\_BENCH\_TIMERR\_H}
\end{DoxyCode}
