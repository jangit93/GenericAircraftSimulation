\hypertarget{eigen_2bench_2sparse__trisolver_8cpp_source}{}\section{eigen/bench/sparse\+\_\+trisolver.cpp}
\label{eigen_2bench_2sparse__trisolver_8cpp_source}\index{sparse\+\_\+trisolver.\+cpp@{sparse\+\_\+trisolver.\+cpp}}

\begin{DoxyCode}
00001 
00002 \textcolor{comment}{//g++ -O3 -g0 -DNDEBUG  sparse\_product.cpp -I.. -I/home/gael/Coding/LinearAlgebra/mtl4/ -DDENSITY=0.005
       -DSIZE=10000 && ./a.out}
00003 \textcolor{comment}{//g++ -O3 -g0 -DNDEBUG  sparse\_product.cpp -I.. -I/home/gael/Coding/LinearAlgebra/mtl4/ -DDENSITY=0.05
       -DSIZE=2000 && ./a.out}
00004 \textcolor{comment}{// -DNOGMM -DNOMTL}
00005 \textcolor{comment}{// -I /home/gael/Coding/LinearAlgebra/CSparse/Include/
       /home/gael/Coding/LinearAlgebra/CSparse/Lib/libcsparse.a}
00006 
00007 \textcolor{preprocessor}{#ifndef SIZE}
00008 \textcolor{preprocessor}{#define SIZE 10000}
00009 \textcolor{preprocessor}{#endif}
00010 
00011 \textcolor{preprocessor}{#ifndef DENSITY}
00012 \textcolor{preprocessor}{#define DENSITY 0.01}
00013 \textcolor{preprocessor}{#endif}
00014 
00015 \textcolor{preprocessor}{#ifndef REPEAT}
00016 \textcolor{preprocessor}{#define REPEAT 1}
00017 \textcolor{preprocessor}{#endif}
00018 
00019 \textcolor{preprocessor}{#include "BenchSparseUtil.h"}
00020 
00021 \textcolor{preprocessor}{#ifndef MINDENSITY}
00022 \textcolor{preprocessor}{#define MINDENSITY 0.0004}
00023 \textcolor{preprocessor}{#endif}
00024 
00025 \textcolor{preprocessor}{#ifndef NBTRIES}
00026 \textcolor{preprocessor}{#define NBTRIES 10}
00027 \textcolor{preprocessor}{#endif}
00028 
00029 \textcolor{preprocessor}{#define BENCH(X) \(\backslash\)}
00030 \textcolor{preprocessor}{  timer.reset(); \(\backslash\)}
00031 \textcolor{preprocessor}{  for (int \_j=0; \_j<NBTRIES; ++\_j) \{ \(\backslash\)}
00032 \textcolor{preprocessor}{    timer.start(); \(\backslash\)}
00033 \textcolor{preprocessor}{    for (int \_k=0; \_k<REPEAT; ++\_k) \{ \(\backslash\)}
00034 \textcolor{preprocessor}{        X  \(\backslash\)}
00035 \textcolor{preprocessor}{  \} timer.stop(); \}}
00036 
00037 \textcolor{keyword}{typedef} \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<Scalar,UpperTriangular>} 
      \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{EigenSparseTriMatrix};
00038 \textcolor{keyword}{typedef} \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{SparseMatrix<Scalar,RowMajorBit|UpperTriangular>} 
      \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{EigenSparseTriMatrixRow};
00039 
00040 \textcolor{keywordtype}{void} fillMatrix(\textcolor{keywordtype}{float} density, \textcolor{keywordtype}{int} rows, \textcolor{keywordtype}{int} cols,  \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{EigenSparseTriMatrix}& dst)
00041 \{
00042   dst.startFill(rows*cols*density);
00043   \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} j = 0; j < cols; j++)
00044   \{
00045     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < j; i++)
00046     \{
00047       Scalar v = (internal::random<float>(0,1) < density) ? internal::random<Scalar>() : 0;
00048       \textcolor{keywordflow}{if} (v!=0)
00049         dst.fill(i,j) = v;
00050     \}
00051     dst.fill(j,j) = internal::random<Scalar>();
00052   \}
00053   dst.endFill();
00054 \}
00055 
00056 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} *argv[])
00057 \{
00058   \textcolor{keywordtype}{int} rows = SIZE;
00059   \textcolor{keywordtype}{int} cols = SIZE;
00060   \textcolor{keywordtype}{float} density = DENSITY;
00061   \hyperlink{class_eigen_1_1_bench_timer}{BenchTimer} timer;
00062 \textcolor{preprocessor}{  #if 1}
00063   \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{EigenSparseTriMatrix} sm1(rows,cols);
00064   \textcolor{keyword}{typedef} \hyperlink{group___core___module}{Matrix<Scalar,Dynamic,1>} \hyperlink{group___core___module}{DenseVector};
00065   DenseVector b = DenseVector::Random(cols);
00066   DenseVector x = DenseVector::Random(cols);
00067 
00068   \textcolor{keywordtype}{bool} densedone = \textcolor{keyword}{false};
00069 
00070   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{float} density = DENSITY; density>=MINDENSITY; density*=0.5)
00071   \{
00072     \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{EigenSparseTriMatrix} sm1(rows, cols);
00073     fillMatrix(density, rows, cols, sm1);
00074 
00075     \textcolor{comment}{// dense matrices}
00076 \textcolor{preprocessor}{    #ifdef DENSEMATRIX}
00077     \textcolor{keywordflow}{if} (!densedone)
00078     \{
00079       densedone = \textcolor{keyword}{true};
00080       std::cout << \textcolor{stringliteral}{"Eigen Dense\(\backslash\)t"} << density*100 << \textcolor{stringliteral}{"%\(\backslash\)n"};
00081       \hyperlink{group___core___module}{DenseMatrix} m1(rows,cols);
00082       \hyperlink{group___core___module_class_eigen_1_1_matrix}{Matrix<Scalar,Dynamic,Dynamic,Dynamic,Dynamic,RowMajorBit>}
       m2(rows,cols);
00083       eiToDense(sm1, m1);
00084       m2 = m1;
00085 
00086       BENCH(x = m1.marked<UpperTriangular>().solveTriangular(b);)
00087       std::cout << \textcolor{stringliteral}{"   colmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00088 \textcolor{comment}{//       std::cerr << x.transpose() << "\(\backslash\)n";}
00089 
00090       BENCH(x = m2.marked<UpperTriangular>().solveTriangular(b);)
00091       std::cout << \textcolor{stringliteral}{"   rowmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00092 \textcolor{comment}{//       std::cerr << x.transpose() << "\(\backslash\)n";}
00093     \}
00094 \textcolor{preprocessor}{    #endif}
00095 
00096     \textcolor{comment}{// eigen sparse matrices}
00097     \{
00098       std::cout << \textcolor{stringliteral}{"Eigen sparse\(\backslash\)t"} << density*100 << \textcolor{stringliteral}{"%\(\backslash\)n"};
00099       \hyperlink{group___sparse_core___module_class_eigen_1_1_sparse_matrix}{EigenSparseTriMatrixRow} sm2 = sm1;
00100 
00101       BENCH(x = sm1.solveTriangular(b);)
00102       std::cout << \textcolor{stringliteral}{"   colmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00103 \textcolor{comment}{//       std::cerr << x.transpose() << "\(\backslash\)n";}
00104 
00105       BENCH(x = sm2.solveTriangular(b);)
00106       std::cout << \textcolor{stringliteral}{"   rowmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00107 \textcolor{comment}{//       std::cerr << x.transpose() << "\(\backslash\)n";}
00108 
00109 \textcolor{comment}{//       x = b;}
00110 \textcolor{comment}{//       BENCH(sm1.inverseProductInPlace(x);)}
00111 \textcolor{comment}{//       std::cout << "   colmajor^-1 * b:\(\backslash\)t" << timer.value() << " (inplace)" << endl;}
00112 \textcolor{comment}{//       std::cerr << x.transpose() << "\(\backslash\)n";}
00113 \textcolor{comment}{//}
00114 \textcolor{comment}{//       x = b;}
00115 \textcolor{comment}{//       BENCH(sm2.inverseProductInPlace(x);)}
00116 \textcolor{comment}{//       std::cout << "   rowmajor^-1 * b:\(\backslash\)t" << timer.value() << " (inplace)" << endl;}
00117 \textcolor{comment}{//       std::cerr << x.transpose() << "\(\backslash\)n";}
00118     \}
00119 
00120 
00121 
00122     \textcolor{comment}{// CSparse}
00123 \textcolor{preprocessor}{    #ifdef CSPARSE}
00124     \{
00125       std::cout << \textcolor{stringliteral}{"CSparse \(\backslash\)t"} << density*100 << \textcolor{stringliteral}{"%\(\backslash\)n"};
00126       cs *m1;
00127       eiToCSparse(sm1, m1);
00128 
00129       BENCH(x = b; \textcolor{keywordflow}{if} (!cs\_lsolve (m1, x.\hyperlink{class_eigen_1_1_plain_object_base_ac25699535374b1854cf8494e44ad31b2}{data}()))\{std::cerr << \textcolor{stringliteral}{"cs\_lsolve failed\(\backslash\)n"}; \textcolor{keywordflow}{break};\}; )
00130       std::cout << \textcolor{stringliteral}{"   colmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00131     \}
00132 \textcolor{preprocessor}{    #endif}
00133 
00134     \textcolor{comment}{// GMM++}
00135 \textcolor{preprocessor}{    #ifndef NOGMM}
00136     \{
00137       std::cout << \textcolor{stringliteral}{"GMM++ sparse\(\backslash\)t"} << density*100 << \textcolor{stringliteral}{"%\(\backslash\)n"};
00138       GmmSparse m1(rows,cols);
00139       gmm::csr\_matrix<Scalar> m2;
00140       eiToGmm(sm1, m1);
00141       gmm::copy(m1,m2);
00142       std::vector<Scalar> gmmX(cols), gmmB(cols);
00143       \hyperlink{group___core___module_class_eigen_1_1_map}{Map<Matrix<Scalar,Dynamic,1>} >(&gmmX[0], cols) = x;
00144       \hyperlink{group___core___module_class_eigen_1_1_map}{Map<Matrix<Scalar,Dynamic,1>} >(&gmmB[0], cols) = b;
00145 
00146       gmmX = gmmB;
00147       BENCH(gmm::upper\_tri\_solve(m1, gmmX, \textcolor{keyword}{false});)
00148       std::cout << \textcolor{stringliteral}{"   colmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00149 \textcolor{comment}{//       std::cerr << Map<Matrix<Scalar,Dynamic,1> >(&gmmX[0], cols).transpose() << "\(\backslash\)n";}
00150 
00151       gmmX = gmmB;
00152       BENCH(gmm::upper\_tri\_solve(m2, gmmX, \textcolor{keyword}{false});)
00153       timer.stop();
00154       std::cout << \textcolor{stringliteral}{"   rowmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00155 \textcolor{comment}{//       std::cerr << Map<Matrix<Scalar,Dynamic,1> >(&gmmX[0], cols).transpose() << "\(\backslash\)n";}
00156     \}
00157 \textcolor{preprocessor}{    #endif}
00158 
00159     \textcolor{comment}{// MTL4}
00160 \textcolor{preprocessor}{    #ifndef NOMTL}
00161     \{
00162       std::cout << \textcolor{stringliteral}{"MTL4\(\backslash\)t"} << density*100 << \textcolor{stringliteral}{"%\(\backslash\)n"};
00163       MtlSparse m1(rows,cols);
00164       MtlSparseRowMajor m2(rows,cols);
00165       eiToMtl(sm1, m1);
00166       m2 = m1;
00167       mtl::dense\_vector<Scalar> x(rows, 1.0);
00168       mtl::dense\_vector<Scalar> b(rows, 1.0);
00169 
00170       BENCH(x = mtl::upper\_trisolve(m1,b);)
00171       std::cout << \textcolor{stringliteral}{"   colmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00172 \textcolor{comment}{//       std::cerr << x << "\(\backslash\)n";}
00173 
00174       BENCH(x = mtl::upper\_trisolve(m2,b);)
00175       std::cout << \textcolor{stringliteral}{"   rowmajor^-1 * b:\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00176 \textcolor{comment}{//       std::cerr << x << "\(\backslash\)n";}
00177     \}
00178 \textcolor{preprocessor}{    #endif}
00179 
00180 
00181     std::cout << \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)n"};
00182   \}
00183 \textcolor{preprocessor}{  #endif}
00184 
00185 \textcolor{preprocessor}{  #if 0}
00186     \textcolor{comment}{// bench small matrices (in-place versus return bye value)}
00187     \{
00188       timer.reset();
00189       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \_j=0; \_j<10; ++\_j) \{
00190         Matrix4f m = Matrix4f::Random();
00191         Vector4f b = Vector4f::Random();
00192         Vector4f x = Vector4f::Random();
00193         timer.start();
00194         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \_k=0; \_k<1000000; ++\_k) \{
00195           b = m.inverseProduct(b);
00196         \}
00197         timer.stop();
00198       \}
00199       std::cout << \textcolor{stringliteral}{"4x4 :\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00200     \}
00201 
00202     \{
00203       timer.reset();
00204       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \_j=0; \_j<10; ++\_j) \{
00205         Matrix4f m = Matrix4f::Random();
00206         Vector4f b = Vector4f::Random();
00207         Vector4f x = Vector4f::Random();
00208         timer.start();
00209         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \_k=0; \_k<1000000; ++\_k) \{
00210           m.inverseProductInPlace(x);
00211         \}
00212         timer.stop();
00213       \}
00214       std::cout << \textcolor{stringliteral}{"4x4 IP :\(\backslash\)t"} << timer.\hyperlink{class_eigen_1_1_bench_timer_a26760f963ed8b64c126159bfea57735e}{value}() << endl;
00215     \}
00216 \textcolor{preprocessor}{  #endif}
00217 
00218   \textcolor{keywordflow}{return} 0;
00219 \}
00220 
\end{DoxyCode}
