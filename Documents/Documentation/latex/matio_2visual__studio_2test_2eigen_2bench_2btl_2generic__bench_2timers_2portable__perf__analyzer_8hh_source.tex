\hypertarget{matio_2visual__studio_2test_2eigen_2bench_2btl_2generic__bench_2timers_2portable__perf__analyzer_8hh_source}{}\section{matio/visual\+\_\+studio/test/eigen/bench/btl/generic\+\_\+bench/timers/portable\+\_\+perf\+\_\+analyzer.hh}
\label{matio_2visual__studio_2test_2eigen_2bench_2btl_2generic__bench_2timers_2portable__perf__analyzer_8hh_source}\index{portable\+\_\+perf\+\_\+analyzer.\+hh@{portable\+\_\+perf\+\_\+analyzer.\+hh}}

\begin{DoxyCode}
00001 \textcolor{comment}{//=====================================================}
00002 \textcolor{comment}{// File   :  portable\_perf\_analyzer.hh}
00003 \textcolor{comment}{// Author :  L. Plagne <laurent.plagne@edf.fr)>}
00004 \textcolor{comment}{// Copyright (C) EDF R&D,  mar dï¿½c 3 18:59:35 CET 2002}
00005 \textcolor{comment}{// Copyright (C) 2008 Gael Guennebaud <gael.guennebaud@inria.fr>}
00006 \textcolor{comment}{//=====================================================}
00007 \textcolor{comment}{//}
00008 \textcolor{comment}{// This program is free software; you can redistribute it and/or}
00009 \textcolor{comment}{// modify it under the terms of the GNU General Public License}
00010 \textcolor{comment}{// as published by the Free Software Foundation; either version 2}
00011 \textcolor{comment}{// of the License, or (at your option) any later version.}
00012 \textcolor{comment}{//}
00013 \textcolor{comment}{// This program is distributed in the hope that it will be useful,}
00014 \textcolor{comment}{// but WITHOUT ANY WARRANTY; without even the implied warranty of}
00015 \textcolor{comment}{// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00016 \textcolor{comment}{// GNU General Public License for more details.}
00017 \textcolor{comment}{// You should have received a copy of the GNU General Public License}
00018 \textcolor{comment}{// along with this program; if not, write to the Free Software}
00019 \textcolor{comment}{// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.}
00020 \textcolor{comment}{//}
00021 \textcolor{preprocessor}{#ifndef \_PORTABLE\_PERF\_ANALYZER\_HH}
00022 \textcolor{preprocessor}{#define \_PORTABLE\_PERF\_ANALYZER\_HH}
00023 
00024 \textcolor{preprocessor}{#include "utilities.h"}
00025 \textcolor{preprocessor}{#include "timers/portable\_timer.hh"}
00026 
00027 \textcolor{keyword}{template} <\textcolor{keyword}{class} Action>
00028 \textcolor{keyword}{class }\hyperlink{class_portable___perf___analyzer}{Portable\_Perf\_Analyzer}\{
00029 \textcolor{keyword}{public}:
00030   \hyperlink{class_portable___perf___analyzer}{Portable\_Perf\_Analyzer}( ):\_nb\_calc(0), m\_time\_action(0), \_chronos()\{
00031     MESSAGE(\textcolor{stringliteral}{"Portable\_Perf\_Analyzer Ctor"});
00032   \};
00033   \hyperlink{class_portable___perf___analyzer}{Portable\_Perf\_Analyzer}( \textcolor{keyword}{const} \hyperlink{class_portable___perf___analyzer}{Portable\_Perf\_Analyzer} & )\{
00034     INFOS(\textcolor{stringliteral}{"Copy Ctor not implemented"});
00035     exit(0);
00036   \};
00037   ~\hyperlink{class_portable___perf___analyzer}{Portable\_Perf\_Analyzer}()\{
00038     MESSAGE(\textcolor{stringliteral}{"Portable\_Perf\_Analyzer Dtor"});
00039   \};
00040 
00041   BTL\_DONT\_INLINE \textcolor{keywordtype}{double} eval\_mflops(\textcolor{keywordtype}{int} size)
00042   \{
00043     Action action(size);
00044 
00045 \textcolor{comment}{//     action.initialize();}
00046 \textcolor{comment}{//     time\_action = time\_calculate(action);}
00047     \textcolor{keywordflow}{while} (m\_time\_action < MIN\_TIME)
00048     \{
00049       \textcolor{keywordflow}{if}(\_nb\_calc==0) \_nb\_calc = 1;
00050       \textcolor{keywordflow}{else}            \_nb\_calc *= 2;
00051       action.initialize();
00052       m\_time\_action = time\_calculate(action);
00053     \}
00054 
00055     \textcolor{comment}{// optimize}
00056     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=1; i<BtlConfig::Instance.tries; ++i)
00057     \{
00058       Action \_action(size);
00059       std::cout << \textcolor{stringliteral}{" "} << \_action.nb\_op\_base()*\_nb\_calc/(m\_time\_action*1e6) << \textcolor{stringliteral}{" "};
00060       \_action.initialize();
00061       m\_time\_action = std::min(m\_time\_action, time\_calculate(\_action));
00062     \}
00063 
00064     \textcolor{keywordtype}{double} time\_action = m\_time\_action / (double(\_nb\_calc));
00065 
00066     \textcolor{comment}{// check}
00067     \textcolor{keywordflow}{if} (BtlConfig::Instance.checkResults && size<128)
00068     \{
00069       action.initialize();
00070       action.calculate();
00071       action.check\_result();
00072     \}
00073     \textcolor{keywordflow}{return} action.nb\_op\_base()/(time\_action*1e6);
00074   \}
00075 
00076   BTL\_DONT\_INLINE \textcolor{keywordtype}{double} time\_calculate(Action & action)
00077   \{
00078     \textcolor{comment}{// time measurement}
00079     action.calculate();
00080     \_chronos.start();
00081     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} ii=0;ii<\_nb\_calc;ii++)
00082     \{
00083       action.calculate();
00084     \}
00085     \_chronos.stop();
00086     \textcolor{keywordflow}{return} \_chronos.user\_time();
00087   \}
00088 
00089   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} get\_nb\_calc()
00090   \{
00091     \textcolor{keywordflow}{return} \_nb\_calc;
00092   \}
00093 
00094 
00095 \textcolor{keyword}{private}:
00096   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \_nb\_calc;
00097   \textcolor{keywordtype}{double} m\_time\_action;
00098   \hyperlink{class_portable___timer}{Portable\_Timer} \_chronos;
00099 
00100 \};
00101 
00102 \textcolor{preprocessor}{#endif //\_PORTABLE\_PERF\_ANALYZER\_HH}
00103 
\end{DoxyCode}
