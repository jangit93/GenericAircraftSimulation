\hypertarget{zlib_2contrib_2minizip_2miniunz_8c_source}{}\section{zlib/contrib/minizip/miniunz.c}
\label{zlib_2contrib_2minizip_2miniunz_8c_source}\index{miniunz.\+c@{miniunz.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{   miniunz.c}
00003 \textcolor{comment}{   Version 1.1, February 14h, 2010}
00004 \textcolor{comment}{   sample part of the MiniZip project - ( http://www.winimage.com/zLibDll/minizip.html )}
00005 \textcolor{comment}{}
00006 \textcolor{comment}{         Copyright (C) 1998-2010 Gilles Vollant (minizip) ( http://www.winimage.com/zLibDll/minizip.html )}
00007 \textcolor{comment}{}
00008 \textcolor{comment}{         Modifications of Unzip for Zip64}
00009 \textcolor{comment}{         Copyright (C) 2007-2008 Even Rouault}
00010 \textcolor{comment}{}
00011 \textcolor{comment}{         Modifications for Zip64 support on both zip and unzip}
00012 \textcolor{comment}{         Copyright (C) 2009-2010 Mathias Svensson ( http://result42.com )}
00013 \textcolor{comment}{*/}
00014 
00015 \textcolor{preprocessor}{#if (!defined(\_WIN32)) && (!defined(WIN32)) && (!defined(\_\_APPLE\_\_))}
00016 \textcolor{preprocessor}{        #ifndef \_\_USE\_FILE\_OFFSET64}
00017 \textcolor{preprocessor}{                #define \_\_USE\_FILE\_OFFSET64}
00018 \textcolor{preprocessor}{        #endif}
00019 \textcolor{preprocessor}{        #ifndef \_\_USE\_LARGEFILE64}
00020 \textcolor{preprocessor}{                #define \_\_USE\_LARGEFILE64}
00021 \textcolor{preprocessor}{        #endif}
00022 \textcolor{preprocessor}{        #ifndef \_LARGEFILE64\_SOURCE}
00023 \textcolor{preprocessor}{                #define \_LARGEFILE64\_SOURCE}
00024 \textcolor{preprocessor}{        #endif}
00025 \textcolor{preprocessor}{        #ifndef \_FILE\_OFFSET\_BIT}
00026 \textcolor{preprocessor}{                #define \_FILE\_OFFSET\_BIT 64}
00027 \textcolor{preprocessor}{        #endif}
00028 \textcolor{preprocessor}{#endif}
00029 
00030 \textcolor{preprocessor}{#ifdef \_\_APPLE\_\_}
00031 \textcolor{comment}{// In darwin and perhaps other BSD variants off\_t is a 64 bit value, hence no need for specific 64 bit
       functions}
00032 \textcolor{preprocessor}{#define FOPEN\_FUNC(filename, mode) fopen(filename, mode)}
00033 \textcolor{preprocessor}{#define FTELLO\_FUNC(stream) ftello(stream)}
00034 \textcolor{preprocessor}{#define FSEEKO\_FUNC(stream, offset, origin) fseeko(stream, offset, origin)}
00035 \textcolor{preprocessor}{#else}
00036 \textcolor{preprocessor}{#define FOPEN\_FUNC(filename, mode) fopen64(filename, mode)}
00037 \textcolor{preprocessor}{#define FTELLO\_FUNC(stream) ftello64(stream)}
00038 \textcolor{preprocessor}{#define FSEEKO\_FUNC(stream, offset, origin) fseeko64(stream, offset, origin)}
00039 \textcolor{preprocessor}{#endif}
00040 
00041 
00042 \textcolor{preprocessor}{#include <stdio.h>}
00043 \textcolor{preprocessor}{#include <stdlib.h>}
00044 \textcolor{preprocessor}{#include <string.h>}
00045 \textcolor{preprocessor}{#include <time.h>}
00046 \textcolor{preprocessor}{#include <errno.h>}
00047 \textcolor{preprocessor}{#include <fcntl.h>}
00048 
00049 \textcolor{preprocessor}{#ifdef \_WIN32}
00050 \textcolor{preprocessor}{# include <direct.h>}
00051 \textcolor{preprocessor}{# include <io.h>}
00052 \textcolor{preprocessor}{#else}
00053 \textcolor{preprocessor}{# include <unistd.h>}
00054 \textcolor{preprocessor}{# include <utime.h>}
00055 \textcolor{preprocessor}{#endif}
00056 
00057 
00058 \textcolor{preprocessor}{#include "unzip.h"}
00059 
00060 \textcolor{preprocessor}{#define CASESENSITIVITY (0)}
00061 \textcolor{preprocessor}{#define WRITEBUFFERSIZE (8192)}
00062 \textcolor{preprocessor}{#define MAXFILENAME (256)}
00063 
00064 \textcolor{preprocessor}{#ifdef \_WIN32}
00065 \textcolor{preprocessor}{#define USEWIN32IOAPI}
00066 \textcolor{preprocessor}{#include "iowin32.h"}
00067 \textcolor{preprocessor}{#endif}
00068 \textcolor{comment}{/*}
00069 \textcolor{comment}{  mini unzip, demo of unzip package}
00070 \textcolor{comment}{}
00071 \textcolor{comment}{  usage :}
00072 \textcolor{comment}{  Usage : miniunz [-exvlo] file.zip [file\_to\_extract] [-d extractdir]}
00073 \textcolor{comment}{}
00074 \textcolor{comment}{  list the file in the zipfile, and print the content of FILE\_ID.ZIP or README.TXT}
00075 \textcolor{comment}{    if it exists}
00076 \textcolor{comment}{*/}
00077 
00078 
00079 \textcolor{comment}{/* change\_file\_date : change the date/time of a file}
00080 \textcolor{comment}{    filename : the filename of the file where date/time must be modified}
00081 \textcolor{comment}{    dosdate : the new date at the MSDos format (4 bytes)}
00082 \textcolor{comment}{    tmu\_date : the SAME new date at the tm\_unz format */}
00083 \textcolor{keywordtype}{void} change\_file\_date(filename,dosdate,tmu\_date)
00084     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *filename;
00085     uLong dosdate;
00086     \hyperlink{structtm__unz__s}{tm\_unz} tmu\_date;
00087 \{
00088 \textcolor{preprocessor}{#ifdef \_WIN32}
00089   HANDLE hFile;
00090   FILETIME ftm,ftLocal,ftCreate,ftLastAcc,ftLastWrite;
00091 
00092   hFile = CreateFileA(filename,GENERIC\_READ | GENERIC\_WRITE,
00093                       0,NULL,OPEN\_EXISTING,0,NULL);
00094   GetFileTime(hFile,&ftCreate,&ftLastAcc,&ftLastWrite);
00095   DosDateTimeToFileTime((WORD)(dosdate>>16),(WORD)dosdate,&ftLocal);
00096   LocalFileTimeToFileTime(&ftLocal,&ftm);
00097   SetFileTime(hFile,&ftm,&ftLastAcc,&ftm);
00098   CloseHandle(hFile);
00099 \textcolor{preprocessor}{#else}
00100 \textcolor{preprocessor}{#ifdef unix || \_\_APPLE\_\_}
00101   \textcolor{keyword}{struct }utimbuf ut;
00102   \textcolor{keyword}{struct }tm newdate;
00103   newdate.tm\_sec = tmu\_date.tm\_sec;
00104   newdate.tm\_min=tmu\_date.tm\_min;
00105   newdate.tm\_hour=tmu\_date.tm\_hour;
00106   newdate.tm\_mday=tmu\_date.tm\_mday;
00107   newdate.tm\_mon=tmu\_date.tm\_mon;
00108   \textcolor{keywordflow}{if} (tmu\_date.tm\_year > 1900)
00109       newdate.tm\_year=tmu\_date.tm\_year - 1900;
00110   \textcolor{keywordflow}{else}
00111       newdate.tm\_year=tmu\_date.tm\_year ;
00112   newdate.tm\_isdst=-1;
00113 
00114   ut.actime=ut.modtime=mktime(&newdate);
00115   utime(filename,&ut);
00116 \textcolor{preprocessor}{#endif}
00117 \textcolor{preprocessor}{#endif}
00118 \}
00119 
00120 
00121 \textcolor{comment}{/* mymkdir and change\_file\_date are not 100 % portable}
00122 \textcolor{comment}{   As I don't know well Unix, I wait feedback for the unix portion */}
00123 
00124 \textcolor{keywordtype}{int} mymkdir(dirname)
00125     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* dirname;
00126 \{
00127     \textcolor{keywordtype}{int} ret=0;
00128 \textcolor{preprocessor}{#ifdef \_WIN32}
00129     ret = \_mkdir(dirname);
00130 \textcolor{preprocessor}{#elif unix}
00131     ret = mkdir (dirname,0775);
00132 \textcolor{preprocessor}{#elif \_\_APPLE\_\_}
00133     ret = mkdir (dirname,0775);
00134 \textcolor{preprocessor}{#endif}
00135     \textcolor{keywordflow}{return} ret;
00136 \}
00137 
00138 \textcolor{keywordtype}{int} makedir (newdir)
00139     \textcolor{keywordtype}{char} *newdir;
00140 \{
00141   \textcolor{keywordtype}{char} *buffer ;
00142   \textcolor{keywordtype}{char} *p;
00143   \textcolor{keywordtype}{int}  len = (int)strlen(newdir);
00144 
00145   \textcolor{keywordflow}{if} (len <= 0)
00146     \textcolor{keywordflow}{return} 0;
00147 
00148   buffer = (\textcolor{keywordtype}{char}*)malloc(len+1);
00149         \textcolor{keywordflow}{if} (buffer==NULL)
00150         \{
00151                 printf(\textcolor{stringliteral}{"Error allocating memory\(\backslash\)n"});
00152                 \textcolor{keywordflow}{return} UNZ\_INTERNALERROR;
00153         \}
00154   strcpy(buffer,newdir);
00155 
00156   \textcolor{keywordflow}{if} (buffer[len-1] == \textcolor{charliteral}{'/'}) \{
00157     buffer[len-1] = \textcolor{charliteral}{'\(\backslash\)0'};
00158   \}
00159   \textcolor{keywordflow}{if} (mymkdir(buffer) == 0)
00160     \{
00161       free(buffer);
00162       \textcolor{keywordflow}{return} 1;
00163     \}
00164 
00165   p = buffer+1;
00166   \textcolor{keywordflow}{while} (1)
00167     \{
00168       \textcolor{keywordtype}{char} hold;
00169 
00170       \textcolor{keywordflow}{while}(*p && *p != \textcolor{charliteral}{'\(\backslash\)\(\backslash\)'} && *p != \textcolor{charliteral}{'/'})
00171         p++;
00172       hold = *p;
00173       *p = 0;
00174       \textcolor{keywordflow}{if} ((mymkdir(buffer) == -1) && (errno == ENOENT))
00175         \{
00176           printf(\textcolor{stringliteral}{"couldn't create directory %s\(\backslash\)n"},buffer);
00177           free(buffer);
00178           \textcolor{keywordflow}{return} 0;
00179         \}
00180       \textcolor{keywordflow}{if} (hold == 0)
00181         \textcolor{keywordflow}{break};
00182       *p++ = hold;
00183     \}
00184   free(buffer);
00185   \textcolor{keywordflow}{return} 1;
00186 \}
00187 
00188 \textcolor{keywordtype}{void} do\_banner()
00189 \{
00190     printf(\textcolor{stringliteral}{"MiniUnz 1.01b, demo of zLib + Unz package written by Gilles Vollant\(\backslash\)n"});
00191     printf(\textcolor{stringliteral}{"more info at http://www.winimage.com/zLibDll/unzip.html\(\backslash\)n\(\backslash\)n"});
00192 \}
00193 
00194 \textcolor{keywordtype}{void} do\_help()
00195 \{
00196     printf(\textcolor{stringliteral}{"Usage : miniunz [-e] [-x] [-v] [-l] [-o] [-p password] file.zip [file\_to\_extr.] [-d extractdir]
      \(\backslash\)n\(\backslash\)n"} \(\backslash\)
00197            \textcolor{stringliteral}{"  -e  Extract without pathname (junk paths)\(\backslash\)n"} \(\backslash\)
00198            \textcolor{stringliteral}{"  -x  Extract with pathname\(\backslash\)n"} \(\backslash\)
00199            \textcolor{stringliteral}{"  -v  list files\(\backslash\)n"} \(\backslash\)
00200            \textcolor{stringliteral}{"  -l  list files\(\backslash\)n"} \(\backslash\)
00201            \textcolor{stringliteral}{"  -d  directory to extract into\(\backslash\)n"} \(\backslash\)
00202            \textcolor{stringliteral}{"  -o  overwrite files without prompting\(\backslash\)n"} \(\backslash\)
00203            \textcolor{stringliteral}{"  -p  extract crypted file using password\(\backslash\)n\(\backslash\)n"});
00204 \}
00205 
00206 \textcolor{keywordtype}{void} Display64BitsSize(ZPOS64\_T n, \textcolor{keywordtype}{int} size\_char)
00207 \{
00208   \textcolor{comment}{/* to avoid compatibility problem , we do here the conversion */}
00209   \textcolor{keywordtype}{char} number[21];
00210   \textcolor{keywordtype}{int} offset=19;
00211   \textcolor{keywordtype}{int} pos\_string = 19;
00212   number[20]=0;
00213   \textcolor{keywordflow}{for} (;;) \{
00214       number[offset]=(char)((n%10)+\textcolor{charliteral}{'0'});
00215       \textcolor{keywordflow}{if} (number[offset] != \textcolor{charliteral}{'0'})
00216           pos\_string=offset;
00217       n/=10;
00218       \textcolor{keywordflow}{if} (offset==0)
00219           \textcolor{keywordflow}{break};
00220       offset--;
00221   \}
00222   \{
00223       \textcolor{keywordtype}{int} size\_display\_string = 19-pos\_string;
00224       \textcolor{keywordflow}{while} (size\_char > size\_display\_string)
00225       \{
00226           size\_char--;
00227           printf(\textcolor{stringliteral}{" "});
00228       \}
00229   \}
00230 
00231   printf(\textcolor{stringliteral}{"%s"},&number[pos\_string]);
00232 \}
00233 
00234 \textcolor{keywordtype}{int} do\_list(uf)
00235     unzFile uf;
00236 \{
00237     uLong i;
00238     \hyperlink{structunz__global__info64__s}{unz\_global\_info64} gi;
00239     \textcolor{keywordtype}{int} err;
00240 
00241     err = unzGetGlobalInfo64(uf,&gi);
00242     \textcolor{keywordflow}{if} (err!=UNZ\_OK)
00243         printf(\textcolor{stringliteral}{"error %d with zipfile in unzGetGlobalInfo \(\backslash\)n"},err);
00244     printf(\textcolor{stringliteral}{"  Length  Method     Size Ratio   Date    Time   CRC-32     Name\(\backslash\)n"});
00245     printf(\textcolor{stringliteral}{"  ------  ------     ---- -----   ----    ----   ------     ----\(\backslash\)n"});
00246     \textcolor{keywordflow}{for} (i=0;i<gi.number\_entry;i++)
00247     \{
00248         \textcolor{keywordtype}{char} filename\_inzip[256];
00249         \hyperlink{structunz__file__info64__s}{unz\_file\_info64} file\_info;
00250         uLong ratio=0;
00251         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *string\_method;
00252         \textcolor{keywordtype}{char} charCrypt=\textcolor{charliteral}{' '};
00253         err = unzGetCurrentFileInfo64(uf,&file\_info,filename\_inzip,\textcolor{keyword}{sizeof}(filename\_inzip),NULL,0,NULL,0);
00254         \textcolor{keywordflow}{if} (err!=UNZ\_OK)
00255         \{
00256             printf(\textcolor{stringliteral}{"error %d with zipfile in unzGetCurrentFileInfo\(\backslash\)n"},err);
00257             \textcolor{keywordflow}{break};
00258         \}
00259         \textcolor{keywordflow}{if} (file\_info.uncompressed\_size>0)
00260             ratio = (uLong)((file\_info.compressed\_size*100)/file\_info.uncompressed\_size);
00261 
00262         \textcolor{comment}{/* display a '*' if the file is crypted */}
00263         \textcolor{keywordflow}{if} ((file\_info.flag & 1) != 0)
00264             charCrypt=\textcolor{charliteral}{'*'};
00265 
00266         \textcolor{keywordflow}{if} (file\_info.compression\_method==0)
00267             string\_method=\textcolor{stringliteral}{"Stored"};
00268         \textcolor{keywordflow}{else}
00269         \textcolor{keywordflow}{if} (file\_info.compression\_method==Z\_DEFLATED)
00270         \{
00271             uInt iLevel=(uInt)((file\_info.flag & 0x6)/2);
00272             \textcolor{keywordflow}{if} (iLevel==0)
00273               string\_method=\textcolor{stringliteral}{"Defl:N"};
00274             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (iLevel==1)
00275               string\_method=\textcolor{stringliteral}{"Defl:X"};
00276             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((iLevel==2) || (iLevel==3))
00277               string\_method=\textcolor{stringliteral}{"Defl:F"}; \textcolor{comment}{/* 2:fast , 3 : extra fast*/}
00278         \}
00279         \textcolor{keywordflow}{else}
00280         \textcolor{keywordflow}{if} (file\_info.compression\_method==Z\_BZIP2ED)
00281         \{
00282               string\_method=\textcolor{stringliteral}{"BZip2 "};
00283         \}
00284         \textcolor{keywordflow}{else}
00285             string\_method=\textcolor{stringliteral}{"Unkn. "};
00286 
00287         Display64BitsSize(file\_info.uncompressed\_size,7);
00288         printf(\textcolor{stringliteral}{"  %6s%c"},string\_method,charCrypt);
00289         Display64BitsSize(file\_info.compressed\_size,7);
00290         printf(\textcolor{stringliteral}{" %3lu%%  %2.2lu-%2.2lu-%2.2lu  %2.2lu:%2.2lu  %8.8lx   %s\(\backslash\)n"},
00291                 ratio,
00292                 (uLong)file\_info.tmu\_date.tm\_mon + 1,
00293                 (uLong)file\_info.tmu\_date.tm\_mday,
00294                 (uLong)file\_info.tmu\_date.tm\_year % 100,
00295                 (uLong)file\_info.tmu\_date.tm\_hour,(uLong)file\_info.tmu\_date.tm\_min,
00296                 (uLong)file\_info.crc,filename\_inzip);
00297         \textcolor{keywordflow}{if} ((i+1)<gi.number\_entry)
00298         \{
00299             err = unzGoToNextFile(uf);
00300             \textcolor{keywordflow}{if} (err!=UNZ\_OK)
00301             \{
00302                 printf(\textcolor{stringliteral}{"error %d with zipfile in unzGoToNextFile\(\backslash\)n"},err);
00303                 \textcolor{keywordflow}{break};
00304             \}
00305         \}
00306     \}
00307 
00308     \textcolor{keywordflow}{return} 0;
00309 \}
00310 
00311 
00312 \textcolor{keywordtype}{int} do\_extract\_currentfile(uf,popt\_extract\_without\_path,popt\_overwrite,password)
00313     unzFile uf;
00314     \textcolor{keyword}{const} \textcolor{keywordtype}{int}* popt\_extract\_without\_path;
00315     \textcolor{keywordtype}{int}* popt\_overwrite;
00316     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* password;
00317 \{
00318     \textcolor{keywordtype}{char} filename\_inzip[256];
00319     \textcolor{keywordtype}{char}* filename\_withoutpath;
00320     \textcolor{keywordtype}{char}* p;
00321     \textcolor{keywordtype}{int} err=UNZ\_OK;
00322     FILE *fout=NULL;
00323     \textcolor{keywordtype}{void}* buf;
00324     uInt size\_buf;
00325 
00326     \hyperlink{structunz__file__info64__s}{unz\_file\_info64} file\_info;
00327     uLong ratio=0;
00328     err = unzGetCurrentFileInfo64(uf,&file\_info,filename\_inzip,\textcolor{keyword}{sizeof}(filename\_inzip),NULL,0,NULL,0);
00329 
00330     \textcolor{keywordflow}{if} (err!=UNZ\_OK)
00331     \{
00332         printf(\textcolor{stringliteral}{"error %d with zipfile in unzGetCurrentFileInfo\(\backslash\)n"},err);
00333         \textcolor{keywordflow}{return} err;
00334     \}
00335 
00336     size\_buf = WRITEBUFFERSIZE;
00337     buf = (\textcolor{keywordtype}{void}*)malloc(size\_buf);
00338     \textcolor{keywordflow}{if} (buf==NULL)
00339     \{
00340         printf(\textcolor{stringliteral}{"Error allocating memory\(\backslash\)n"});
00341         \textcolor{keywordflow}{return} UNZ\_INTERNALERROR;
00342     \}
00343 
00344     p = filename\_withoutpath = filename\_inzip;
00345     \textcolor{keywordflow}{while} ((*p) != \textcolor{charliteral}{'\(\backslash\)0'})
00346     \{
00347         \textcolor{keywordflow}{if} (((*p)==\textcolor{charliteral}{'/'}) || ((*p)==\textcolor{charliteral}{'\(\backslash\)\(\backslash\)'}))
00348             filename\_withoutpath = p+1;
00349         p++;
00350     \}
00351 
00352     \textcolor{keywordflow}{if} ((*filename\_withoutpath)==\textcolor{charliteral}{'\(\backslash\)0'})
00353     \{
00354         \textcolor{keywordflow}{if} ((*popt\_extract\_without\_path)==0)
00355         \{
00356             printf(\textcolor{stringliteral}{"creating directory: %s\(\backslash\)n"},filename\_inzip);
00357             mymkdir(filename\_inzip);
00358         \}
00359     \}
00360     \textcolor{keywordflow}{else}
00361     \{
00362         \textcolor{keyword}{const} \textcolor{keywordtype}{char}* write\_filename;
00363         \textcolor{keywordtype}{int} skip=0;
00364 
00365         \textcolor{keywordflow}{if} ((*popt\_extract\_without\_path)==0)
00366             write\_filename = filename\_inzip;
00367         \textcolor{keywordflow}{else}
00368             write\_filename = filename\_withoutpath;
00369 
00370         err = unzOpenCurrentFilePassword(uf,password);
00371         \textcolor{keywordflow}{if} (err!=UNZ\_OK)
00372         \{
00373             printf(\textcolor{stringliteral}{"error %d with zipfile in unzOpenCurrentFilePassword\(\backslash\)n"},err);
00374         \}
00375 
00376         \textcolor{keywordflow}{if} (((*popt\_overwrite)==0) && (err==UNZ\_OK))
00377         \{
00378             \textcolor{keywordtype}{char} rep=0;
00379             FILE* ftestexist;
00380             ftestexist = FOPEN\_FUNC(write\_filename,\textcolor{stringliteral}{"rb"});
00381             \textcolor{keywordflow}{if} (ftestexist!=NULL)
00382             \{
00383                 fclose(ftestexist);
00384                 \textcolor{keywordflow}{do}
00385                 \{
00386                     \textcolor{keywordtype}{char} answer[128];
00387                     \textcolor{keywordtype}{int} ret;
00388 
00389                     printf(\textcolor{stringliteral}{"The file %s exists. Overwrite ? [y]es, [n]o, [A]ll: "},write\_filename);
00390                     ret = scanf(\textcolor{stringliteral}{"%1s"},answer);
00391                     \textcolor{keywordflow}{if} (ret != 1)
00392                     \{
00393                        exit(EXIT\_FAILURE);
00394                     \}
00395                     rep = answer[0] ;
00396                     \textcolor{keywordflow}{if} ((rep>=\textcolor{charliteral}{'a'}) && (rep<=\textcolor{charliteral}{'z'}))
00397                         rep -= 0x20;
00398                 \}
00399                 \textcolor{keywordflow}{while} ((rep!=\textcolor{charliteral}{'Y'}) && (rep!=\textcolor{charliteral}{'N'}) && (rep!=\textcolor{charliteral}{'A'}));
00400             \}
00401 
00402             \textcolor{keywordflow}{if} (rep == \textcolor{charliteral}{'N'})
00403                 skip = 1;
00404 
00405             \textcolor{keywordflow}{if} (rep == \textcolor{charliteral}{'A'})
00406                 *popt\_overwrite=1;
00407         \}
00408 
00409         \textcolor{keywordflow}{if} ((skip==0) && (err==UNZ\_OK))
00410         \{
00411             fout=FOPEN\_FUNC(write\_filename,\textcolor{stringliteral}{"wb"});
00412             \textcolor{comment}{/* some zipfile don't contain directory alone before file */}
00413             \textcolor{keywordflow}{if} ((fout==NULL) && ((*popt\_extract\_without\_path)==0) &&
00414                                 (filename\_withoutpath!=(\textcolor{keywordtype}{char}*)filename\_inzip))
00415             \{
00416                 \textcolor{keywordtype}{char} c=*(filename\_withoutpath-1);
00417                 *(filename\_withoutpath-1)=\textcolor{charliteral}{'\(\backslash\)0'};
00418                 makedir(write\_filename);
00419                 *(filename\_withoutpath-1)=c;
00420                 fout=FOPEN\_FUNC(write\_filename,\textcolor{stringliteral}{"wb"});
00421             \}
00422 
00423             \textcolor{keywordflow}{if} (fout==NULL)
00424             \{
00425                 printf(\textcolor{stringliteral}{"error opening %s\(\backslash\)n"},write\_filename);
00426             \}
00427         \}
00428 
00429         \textcolor{keywordflow}{if} (fout!=NULL)
00430         \{
00431             printf(\textcolor{stringliteral}{" extracting: %s\(\backslash\)n"},write\_filename);
00432 
00433             \textcolor{keywordflow}{do}
00434             \{
00435                 err = unzReadCurrentFile(uf,buf,size\_buf);
00436                 \textcolor{keywordflow}{if} (err<0)
00437                 \{
00438                     printf(\textcolor{stringliteral}{"error %d with zipfile in unzReadCurrentFile\(\backslash\)n"},err);
00439                     \textcolor{keywordflow}{break};
00440                 \}
00441                 \textcolor{keywordflow}{if} (err>0)
00442                     \textcolor{keywordflow}{if} (fwrite(buf,err,1,fout)!=1)
00443                     \{
00444                         printf(\textcolor{stringliteral}{"error in writing extracted file\(\backslash\)n"});
00445                         err=UNZ\_ERRNO;
00446                         \textcolor{keywordflow}{break};
00447                     \}
00448             \}
00449             \textcolor{keywordflow}{while} (err>0);
00450             \textcolor{keywordflow}{if} (fout)
00451                     fclose(fout);
00452 
00453             \textcolor{keywordflow}{if} (err==0)
00454                 change\_file\_date(write\_filename,file\_info.dosDate,
00455                                  file\_info.tmu\_date);
00456         \}
00457 
00458         \textcolor{keywordflow}{if} (err==UNZ\_OK)
00459         \{
00460             err = unzCloseCurrentFile (uf);
00461             \textcolor{keywordflow}{if} (err!=UNZ\_OK)
00462             \{
00463                 printf(\textcolor{stringliteral}{"error %d with zipfile in unzCloseCurrentFile\(\backslash\)n"},err);
00464             \}
00465         \}
00466         \textcolor{keywordflow}{else}
00467             unzCloseCurrentFile(uf); \textcolor{comment}{/* don't lose the error */}
00468     \}
00469 
00470     free(buf);
00471     \textcolor{keywordflow}{return} err;
00472 \}
00473 
00474 
00475 \textcolor{keywordtype}{int} do\_extract(uf,opt\_extract\_without\_path,opt\_overwrite,password)
00476     unzFile uf;
00477     \textcolor{keywordtype}{int} opt\_extract\_without\_path;
00478     \textcolor{keywordtype}{int} opt\_overwrite;
00479     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* password;
00480 \{
00481     uLong i;
00482     \hyperlink{structunz__global__info64__s}{unz\_global\_info64} gi;
00483     \textcolor{keywordtype}{int} err;
00484     FILE* fout=NULL;
00485 
00486     err = unzGetGlobalInfo64(uf,&gi);
00487     \textcolor{keywordflow}{if} (err!=UNZ\_OK)
00488         printf(\textcolor{stringliteral}{"error %d with zipfile in unzGetGlobalInfo \(\backslash\)n"},err);
00489 
00490     \textcolor{keywordflow}{for} (i=0;i<gi.number\_entry;i++)
00491     \{
00492         \textcolor{keywordflow}{if} (do\_extract\_currentfile(uf,&opt\_extract\_without\_path,
00493                                       &opt\_overwrite,
00494                                       password) != UNZ\_OK)
00495             \textcolor{keywordflow}{break};
00496 
00497         \textcolor{keywordflow}{if} ((i+1)<gi.number\_entry)
00498         \{
00499             err = unzGoToNextFile(uf);
00500             \textcolor{keywordflow}{if} (err!=UNZ\_OK)
00501             \{
00502                 printf(\textcolor{stringliteral}{"error %d with zipfile in unzGoToNextFile\(\backslash\)n"},err);
00503                 \textcolor{keywordflow}{break};
00504             \}
00505         \}
00506     \}
00507 
00508     \textcolor{keywordflow}{return} 0;
00509 \}
00510 
00511 \textcolor{keywordtype}{int} do\_extract\_onefile(uf,filename,opt\_extract\_without\_path,opt\_overwrite,password)
00512     unzFile uf;
00513     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* filename;
00514     \textcolor{keywordtype}{int} opt\_extract\_without\_path;
00515     \textcolor{keywordtype}{int} opt\_overwrite;
00516     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* password;
00517 \{
00518     \textcolor{keywordtype}{int} err = UNZ\_OK;
00519     \textcolor{keywordflow}{if} (unzLocateFile(uf,filename,CASESENSITIVITY)!=UNZ\_OK)
00520     \{
00521         printf(\textcolor{stringliteral}{"file %s not found in the zipfile\(\backslash\)n"},filename);
00522         \textcolor{keywordflow}{return} 2;
00523     \}
00524 
00525     \textcolor{keywordflow}{if} (do\_extract\_currentfile(uf,&opt\_extract\_without\_path,
00526                                       &opt\_overwrite,
00527                                       password) == UNZ\_OK)
00528         \textcolor{keywordflow}{return} 0;
00529     \textcolor{keywordflow}{else}
00530         \textcolor{keywordflow}{return} 1;
00531 \}
00532 
00533 
00534 \textcolor{keywordtype}{int} main(argc,argv)
00535     \textcolor{keywordtype}{int} argc;
00536     \textcolor{keywordtype}{char} *argv[];
00537 \{
00538     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *zipfilename=NULL;
00539     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *filename\_to\_extract=NULL;
00540     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *password=NULL;
00541     \textcolor{keywordtype}{char} filename\_try[MAXFILENAME+16] = \textcolor{stringliteral}{""};
00542     \textcolor{keywordtype}{int} i;
00543     \textcolor{keywordtype}{int} ret\_value=0;
00544     \textcolor{keywordtype}{int} opt\_do\_list=0;
00545     \textcolor{keywordtype}{int} opt\_do\_extract=1;
00546     \textcolor{keywordtype}{int} opt\_do\_extract\_withoutpath=0;
00547     \textcolor{keywordtype}{int} opt\_overwrite=0;
00548     \textcolor{keywordtype}{int} opt\_extractdir=0;
00549     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *dirname=NULL;
00550     unzFile uf=NULL;
00551 
00552     do\_banner();
00553     \textcolor{keywordflow}{if} (argc==1)
00554     \{
00555         do\_help();
00556         \textcolor{keywordflow}{return} 0;
00557     \}
00558     \textcolor{keywordflow}{else}
00559     \{
00560         \textcolor{keywordflow}{for} (i=1;i<argc;i++)
00561         \{
00562             \textcolor{keywordflow}{if} ((*argv[i])==\textcolor{charliteral}{'-'})
00563             \{
00564                 \textcolor{keyword}{const} \textcolor{keywordtype}{char} *p=argv[i]+1;
00565 
00566                 \textcolor{keywordflow}{while} ((*p)!=\textcolor{charliteral}{'\(\backslash\)0'})
00567                 \{
00568                     \textcolor{keywordtype}{char} c=*(p++);;
00569                     \textcolor{keywordflow}{if} ((c==\textcolor{charliteral}{'l'}) || (c==\textcolor{charliteral}{'L'}))
00570                         opt\_do\_list = 1;
00571                     \textcolor{keywordflow}{if} ((c==\textcolor{charliteral}{'v'}) || (c==\textcolor{charliteral}{'V'}))
00572                         opt\_do\_list = 1;
00573                     \textcolor{keywordflow}{if} ((c==\textcolor{charliteral}{'x'}) || (c==\textcolor{charliteral}{'X'}))
00574                         opt\_do\_extract = 1;
00575                     \textcolor{keywordflow}{if} ((c==\textcolor{charliteral}{'e'}) || (c==\textcolor{charliteral}{'E'}))
00576                         opt\_do\_extract = opt\_do\_extract\_withoutpath = 1;
00577                     \textcolor{keywordflow}{if} ((c==\textcolor{charliteral}{'o'}) || (c==\textcolor{charliteral}{'O'}))
00578                         opt\_overwrite=1;
00579                     \textcolor{keywordflow}{if} ((c==\textcolor{charliteral}{'d'}) || (c==\textcolor{charliteral}{'D'}))
00580                     \{
00581                         opt\_extractdir=1;
00582                         dirname=argv[i+1];
00583                     \}
00584 
00585                     \textcolor{keywordflow}{if} (((c==\textcolor{charliteral}{'p'}) || (c==\textcolor{charliteral}{'P'})) && (i+1<argc))
00586                     \{
00587                         password=argv[i+1];
00588                         i++;
00589                     \}
00590                 \}
00591             \}
00592             \textcolor{keywordflow}{else}
00593             \{
00594                 \textcolor{keywordflow}{if} (zipfilename == NULL)
00595                     zipfilename = argv[i];
00596                 \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((filename\_to\_extract==NULL) && (!opt\_extractdir))
00597                         filename\_to\_extract = argv[i] ;
00598             \}
00599         \}
00600     \}
00601 
00602     \textcolor{keywordflow}{if} (zipfilename!=NULL)
00603     \{
00604 
00605 \textcolor{preprocessor}{#        ifdef USEWIN32IOAPI}
00606         \hyperlink{structzlib__filefunc64__def__s}{zlib\_filefunc64\_def} ffunc;
00607 \textcolor{preprocessor}{#        endif}
00608 
00609         strncpy(filename\_try, zipfilename,MAXFILENAME-1);
00610         \textcolor{comment}{/* strncpy doesnt append the trailing NULL, of the string is too long. */}
00611         filename\_try[ MAXFILENAME ] = \textcolor{charliteral}{'\(\backslash\)0'};
00612 
00613 \textcolor{preprocessor}{#        ifdef USEWIN32IOAPI}
00614         fill\_win32\_filefunc64A(&ffunc);
00615         uf = unzOpen2\_64(zipfilename,&ffunc);
00616 \textcolor{preprocessor}{#        else}
00617         uf = unzOpen64(zipfilename);
00618 \textcolor{preprocessor}{#        endif}
00619         \textcolor{keywordflow}{if} (uf==NULL)
00620         \{
00621             strcat(filename\_try,\textcolor{stringliteral}{".zip"});
00622 \textcolor{preprocessor}{#            ifdef USEWIN32IOAPI}
00623             uf = unzOpen2\_64(filename\_try,&ffunc);
00624 \textcolor{preprocessor}{#            else}
00625             uf = unzOpen64(filename\_try);
00626 \textcolor{preprocessor}{#            endif}
00627         \}
00628     \}
00629 
00630     \textcolor{keywordflow}{if} (uf==NULL)
00631     \{
00632         printf(\textcolor{stringliteral}{"Cannot open %s or %s.zip\(\backslash\)n"},zipfilename,zipfilename);
00633         \textcolor{keywordflow}{return} 1;
00634     \}
00635     printf(\textcolor{stringliteral}{"%s opened\(\backslash\)n"},filename\_try);
00636 
00637     \textcolor{keywordflow}{if} (opt\_do\_list==1)
00638         ret\_value = do\_list(uf);
00639     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (opt\_do\_extract==1)
00640     \{
00641 \textcolor{preprocessor}{#ifdef \_WIN32}
00642         \textcolor{keywordflow}{if} (opt\_extractdir && \_chdir(dirname))
00643 \textcolor{preprocessor}{#else}
00644         \textcolor{keywordflow}{if} (opt\_extractdir && chdir(dirname))
00645 \textcolor{preprocessor}{#endif}
00646         \{
00647           printf(\textcolor{stringliteral}{"Error changing into %s, aborting\(\backslash\)n"}, dirname);
00648           exit(-1);
00649         \}
00650 
00651         \textcolor{keywordflow}{if} (filename\_to\_extract == NULL)
00652             ret\_value = do\_extract(uf, opt\_do\_extract\_withoutpath, opt\_overwrite, password);
00653         \textcolor{keywordflow}{else}
00654             ret\_value = do\_extract\_onefile(uf, filename\_to\_extract, opt\_do\_extract\_withoutpath, 
      opt\_overwrite, password);
00655     \}
00656 
00657     unzClose(uf);
00658 
00659     \textcolor{keywordflow}{return} ret\_value;
00660 \}
\end{DoxyCode}
